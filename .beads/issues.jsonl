{"id":"foodapp-1j85o1","title":"Implement Convex search index for owned content","description":"## Task\nImplement Convex full-text search over owned content for the 'owned search' track.\n\n## What Gets Indexed (Owned Only)\n- Curated place cards: title, summary, mustTry, tags\n- Guides: title, description\n- Reviews: text, dishesTried\n- Dish mentions: placeDishes.dish\n- Taste tags: placeTags.tag\n\n## What Does NOT Get Indexed\n- Provider place names/addresses (we don't have them\\!)\n- Any ephemeral provider content\n\n## Search Index Definition\n```typescript\n// convex/schema.ts\nexport default defineSchema({\n  curatedPlaces: defineTable({...})\n    .searchIndex('search_curated', {\n      searchField: 'searchableText', // Computed field\n      filterFields: ['city', 'locale'],\n    }),\n  \n  reviews: defineTable({...})\n    .searchIndex('search_reviews', {\n      searchField: 'text',\n      filterFields: ['placeKey'],\n    }),\n});\n```\n\n## Searchable Text Computation\nFor curated places, combine fields:\n```typescript\nconst searchableText = [\n  place.title,\n  place.summary,\n  ...(place.mustTry || []),\n  ...(place.tags || []),\n].join(' ');\n```\n\n## Query Flow\n```typescript\n// convex/search.ts\nexport const searchOwned = query({\n  args: { query: v.string(), city: v.optional(v.string()) },\n  handler: async (ctx, { query, city }) => {\n    const curated = await ctx.db\n      .query('curatedPlaces')\n      .withSearchIndex('search_curated', (q) =>\n        q.search('searchableText', query)\n          .eq('city', city)\n      )\n      .take(20);\n    \n    // Also search guides, dish mentions, etc.\n    // Combine and rank results\n    return mergeResults(curated, guides, dishes);\n  },\n});\n```\n\n## Transliteration at Index Time\nWhen creating/updating curated content, normalize and include variants:\n- 'tagine' → also index 'tajine', 'طاجين'\n\n## Acceptance Criteria\n- [ ] Search indexes defined on schema\n- [ ] Curated places searchable\n- [ ] Dish mentions surfacing results\n- [ ] Transliteration matching variants","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:28:05.733213Z","created_by":"osekkat","updated_at":"2026-01-27T13:53:21.032347600Z","closed_at":"2026-01-27T13:53:21.032255052Z","compaction_level":0,"original_size":0,"labels":["convex","owned-content","search"],"dependencies":[{"issue_id":"foodapp-1j85o1","depends_on_id":"foodapp-dmwjyn","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-1j85o1","depends_on_id":"foodapp-il4keg","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-1j85o1","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-1vm307","title":"Install and configure shadcn/ui component library","description":"## Task\nSet up shadcn/ui as the component library foundation.\n\n## Commands\n```bash\nnpx shadcn@latest init\n```\n\n## Why shadcn/ui\n- Not a dependency - components are copied into your codebase\n- Full control over styling and behavior\n- Tailwind-native\n- Accessible by default (Radix primitives)\n- RTL-friendly\n\n## Initial Components to Add\n```bash\nnpx shadcn@latest add button card input dialog sheet\nnpx shadcn@latest add dropdown-menu toast skeleton\nnpx shadcn@latest add tabs avatar badge separator\n```\n\n## Customization\n- Configure Moroccan color palette\n- Set up dark mode support\n- Ensure RTL compatibility\n- Add custom variants as needed\n\n## Directory Structure\n```\ncomponents/\n├── ui/           # shadcn components\n├── maps/         # Map-specific\n├── places/       # Place cards, details\n├── search/       # Search UI\n└── providers/    # Context providers\n```\n\n## Acceptance Criteria\n- [ ] shadcn/ui initialized\n- [ ] Core components added\n- [ ] Custom theme applied\n- [ ] Components rendering correctly","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:24:11.604663Z","created_by":"osekkat","updated_at":"2026-01-27T12:34:25.077452462Z","closed_at":"2026-01-27T12:34:25.077410469Z","close_reason":"shadcn/ui already configured - components present: button, card, input, dialog, sheet, dropdown-menu, sonner, skeleton, tabs, avatar, badge, separator","compaction_level":0,"original_size":0,"labels":["components","setup","ui"],"dependencies":[{"issue_id":"foodapp-1vm307","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-1vm307","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-1x3tg6","title":"Implement RTL layout support for Arabic","description":"## Task\nImplement proper RTL (right-to-left) layout support for Arabic locale.\n\n## Key RTL Considerations\n\n### Document Direction\n```typescript\n// app/layout.tsx\nexport default function RootLayout({ children, params }) {\n  const dir = params.locale === 'ar' ? 'rtl' : 'ltr';\n  return (\n    <html lang={params.locale} dir={dir}>\n      <body className={dir === 'rtl' ? 'font-arabic' : ''}>{children}</body>\n    </html>\n  );\n}\n```\n\n### Tailwind RTL Configuration\n```javascript\n// tailwind.config.js\nmodule.exports = {\n  plugins: [require('tailwindcss-rtl')],\n};\n```\n\nUse RTL-aware utilities:\n- `ms-4` instead of `ml-4` (margin-start)\n- `me-4` instead of `mr-4` (margin-end)\n- `ps-4` instead of `pl-4` (padding-start)\n- `text-start` instead of `text-left`\n\n### Components to Audit\n- Navigation/header\n- Search bar\n- Place cards\n- Review forms\n- Map controls positioning\n- Lists and itineraries\n- Modals and sheets\n\n### Arabic Typography\n```css\n/* Use appropriate Arabic font */\n.font-arabic {\n  font-family: 'IBM Plex Arabic', 'Noto Sans Arabic', sans-serif;\n}\n```\n\n### Icons\nSome icons need to flip in RTL:\n- Arrows (→ becomes ←)\n- Back/forward navigation\n- Chevrons\n\n```typescript\n<ChevronRight className='rtl:rotate-180' />\n```\n\n## Testing\n- Visual regression tests comparing LTR vs RTL\n- Manual review of all pages in Arabic\n- Check form inputs behave correctly\n\n## Acceptance Criteria\n- [ ] All pages render correctly in RTL\n- [ ] Tailwind RTL utilities used throughout\n- [ ] Arabic font loading correctly\n- [ ] Icons flipping where appropriate\n- [ ] Visual regression tests passing","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:24:10.974814Z","created_by":"osekkat","updated_at":"2026-01-27T12:49:09.728508614Z","closed_at":"2026-01-27T12:49:09.728477417Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["arabic","i18n","rtl"],"dependencies":[{"issue_id":"foodapp-1x3tg6","depends_on_id":"foodapp-549wnq","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-1x3tg6","depends_on_id":"foodapp-avek76","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-2bm483","title":"Implement budget guardrails per endpoint class","description":"## Task\nImplement budget enforcement that tracks and limits spend per endpoint class (autocomplete/search/details/photos).\n\n## Why Per-Endpoint Budgets\nDifferent endpoints have different costs and importance:\n- Autocomplete: Many calls, cheap per call\n- Details: Fewer calls, variable cost by field mask\n- Photos: Bandwidth-heavy, can be disabled first\n\n## Budget Structure\n```typescript\ninterface EndpointBudget {\n  endpoint: 'autocomplete' | 'search' | 'details' | 'photos';\n  dailyLimit: number;      // Max calls per day\n  currentCount: number;\n  costPerCall: number;     // Estimated cost for tracking\n  lastResetAt: number;\n}\n```\n\n## Enforcement Logic\n```typescript\nasync function checkBudget(\n  ctx: ActionCtx,\n  endpoint: EndpointClass\n): Promise<BudgetResult> {\n  const budget = await getBudget(ctx, endpoint);\n  \n  if (budget.currentCount >= budget.dailyLimit) {\n    return { allowed: false, reason: 'budget_exceeded' };\n  }\n  \n  // Warn at thresholds\n  const usage = budget.currentCount / budget.dailyLimit;\n  if (usage > 0.8) {\n    await emitWarning(ctx, endpoint, usage);\n  }\n  \n  return { allowed: true };\n}\n```\n\n## Auto-Mitigation on Budget Exceeded\nWhen budget hits limit:\n1. Photos disabled first (most expensive, least critical)\n2. Open-now filter disabled (requires extra calls)\n3. Max results reduced\n4. Eventually trigger Mode 1 (Cost-Saver)\n\n## Integration with Feature Flags\nBudget watchdog cron job:\n- Runs every 5 minutes\n- Checks all endpoint budgets\n- Flips feature flags when thresholds crossed\n\n## Metrics\n- budget_usage_percent (gauge by endpoint)\n- budget_exceeded_events (counter)\n- budget_auto_mitigation_triggers (counter)\n\n## Acceptance Criteria\n- [ ] Per-endpoint tracking working\n- [ ] Limits enforced\n- [ ] Warnings at 80%\n- [ ] Auto-mitigation triggering","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:26:38.886532Z","created_by":"osekkat","updated_at":"2026-01-27T10:16:23.883609376Z","closed_at":"2026-01-27T10:16:23.883571269Z","close_reason":"Implemented budget tracking with 80%/95% warning thresholds and auto-mitigation via feature flags. Functions: checkBudget (with usagePercent, warning, warningLevel), recordBudgetUsage (triggers feature flag updates at 95%/100%), updateFeatureFlag, getFeatureFlag.","compaction_level":0,"original_size":0,"labels":["budget","core","cost-control"],"dependencies":[{"issue_id":"foodapp-2bm483","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-2bm483","depends_on_id":"foodapp-dpikri","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-2ym9m1","title":"Morocco Food Discovery App - Curated Content & Dish Explorer","description":"## Overview\nThis epic builds the editorial/curated content layer and the Dish Explorer feature - key differentiators that work entirely on owned data and function even when providers are unavailable.\n\n## Strategic Importance\nThe biggest product risk is being 'Google Maps, but smaller.' We differentiate by going **dish-first** and **local context-first** using owned content.\n\n## Curated Place Cards\nEditorial content YOU own:\n- Title, summary, neighborhood\n- Must-try dishes, tips, price notes (MAD)\n- Etiquette notes (cash-only, reservation needed, etc.)\n- Amenities tags (Wi-Fi, family-friendly, vegetarian/halal)\n- Cover photos (owned, not provider)\n\n**Key benefit**: Powers SEO, offline mode, and degraded mode backbone.\n\n## Dish Explorer (New V1 Feature)\nBrowse by dish + city → 'top places for this dish'\n\nRanking uses **owned signals only**:\n- Favorites count\n- Dish mentions (`placeDishes.mentionsCount`)\n- Review recency\n\n### placeDishes Schema\n```typescript\nplaceDishes: defineTable({\n  placeKey: v.string(),\n  dish: v.string(),             // normalized key, e.g. 'tagine'\n  mentionsCount: v.number(),\n  lastMentionedAt: v.number(),\n  updatedAt: v.number(),\n})\n```\n\n## Home Page Dish Quick-Picks\nNew addition to MVP:\n- Tagine, Couscous, Pastilla, Seafood, Coffee, Pastries\n- One tap → dish explorer filtered to that dish\n- Works in degraded mode (owned data only)\n\n## Editorial Guides\nCurated lists like 'Best tagine in Marrakech':\n- Owned content with placeKeys\n- SEO-friendly URLs (/guides/{slug})\n- Featured on home page\n- Works offline/degraded\n\n## Degraded Mode Backbone\nCurated content is the fallback when provider is unavailable:\n- Mode 2: curated + owned search only\n- Mode 3: curated cards + notes only\n- Always available, always fast\n\n## Success Criteria\n- [ ] Dish Explorer showing meaningful results\n- [ ] Home page dish quick-picks working\n- [ ] Curated cards powering degraded mode\n- [ ] Guides generating SEO traffic","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:22:38.058261Z","created_by":"osekkat","updated_at":"2026-01-27T17:57:25.336698379Z","closed_at":"2026-01-27T17:57:25.336643857Z","close_reason":"All child tasks completed: editorial guides, Dish Explorer, curated place cards","compaction_level":0,"original_size":0,"labels":["curated","differentiation","dish-explorer","editorial","p1"],"dependencies":[{"issue_id":"foodapp-2ym9m1","depends_on_id":"foodapp-qpbwny","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-35bai9","title":"Implement optimistic updates for user actions","description":"## Task\nImplement optimistic updates for better perceived performance on user interactions.\n\n## Actions to Optimize\n\n### Favorite/Unfavorite\n```typescript\nconst toggleFavorite = useMutation(api.lists.toggleFavorite)\n  .withOptimisticUpdate((localStore, args) => {\n    const place = localStore.getQuery(api.places.get, { id: args.placeId });\n    if (place) {\n      localStore.setQuery(api.places.get, { id: args.placeId }, {\n        ...place,\n        isFavorited: !place.isFavorited,\n        favoritesCount: place.favoritesCount + (place.isFavorited ? -1 : 1),\n      });\n    }\n  });\n```\n\n### Add to List\n- Show item in list immediately\n- Revert on error with toast\n\n### Submit Review\n- Show review with 'Posting...' indicator\n- Update to confirmed state on success\n- Remove and show error on failure\n\n### Helpful Vote\n- Increment count immediately\n- Prevent double-voting client-side\n\n### Tag Vote\n- Update vote count immediately\n- Debounce rapid voting\n\n## Error Handling\n```typescript\nconst mutation = useMutation(api.reviews.create)\n  .withOptimisticUpdate((localStore, args) => {\n    // Optimistic update...\n  });\n\ntry {\n  await mutation(args);\n} catch (error) {\n  // Convex automatically reverts optimistic update\n  toast.error('Failed to save. Please try again.');\n}\n```\n\n## UX Patterns\n- Use subtle loading indicators (spinner in button)\n- Don't block UI during mutation\n- Show success confirmation briefly\n- Clear error handling with retry option\n\n## Testing\n- Test network failure scenarios\n- Test race conditions (rapid clicks)\n- Verify rollback works correctly\n\n## Acceptance Criteria\n- [ ] All specified actions have optimistic updates\n- [ ] Rollback working on errors\n- [ ] No UI jank during mutations\n- [ ] Error feedback clear to users","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:25:04.718085Z","created_by":"osekkat","updated_at":"2026-01-27T17:09:27.522080962Z","closed_at":"2026-01-27T17:09:27.522032439Z","close_reason":"Implemented optimistic updates hook (useOptimisticMutations.ts) with: toggleFavorite, addToList, removeFromList, markHelpful/unmarkHelpful, submitReview, deleteReview, and tagVote. Each hook wraps Convex mutations with optimistic updates for immediate UI feedback.","compaction_level":0,"original_size":0,"labels":["optimistic","performance","ux"],"dependencies":[{"issue_id":"foodapp-35bai9","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-35bai9","depends_on_id":"foodapp-tpsmbw","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-3uo0ry","title":"Implement metrics collection and dashboard","description":"## Task\nSet up metrics collection for the key performance and cost indicators defined in the plan.\n\n## Key Metrics to Track\n\n### Performance\n- Search latency (P50, P95, P99)\n- Place detail load time\n- Map initial render time\n- Time to interactive\n\n### Cost\n- Google Places API calls/hour by endpoint\n- Cache hit rate\n- Cost per active user\n- Photo proxy bandwidth\n- FieldMask/SKU mix\n\n### Business\n- Search-to-detail CTR\n- Detail-to-favorite conversion\n- Reviews per user/week\n\n## Implementation\nUse Convex for storing metrics + a dashboard (can use simple admin page or external tool).\n\n```typescript\n// convex/metrics.ts\nexport const recordMetric = internalMutation({\n  args: {\n    name: v.string(),\n    value: v.number(),\n    tags: v.optional(v.object({ endpoint: v.optional(v.string()) })),\n  },\n  handler: async (ctx, { name, value, tags }) => {\n    await ctx.db.insert('metrics', {\n      name,\n      value,\n      tags,\n      timestamp: Date.now(),\n    });\n  },\n});\n```\n\n## Dashboard\n- Real-time cost tracking\n- Latency percentiles\n- Cache hit rates\n- Error rates by endpoint\n\n## Acceptance Criteria\n- [ ] Metrics being recorded for all key indicators\n- [ ] Dashboard showing real-time data\n- [ ] Historical trends visible\n- [ ] Cost alerts triggering","notes":"Implementation complete by CyanCrane (2026-01-27): Added metrics.ts with recording functions (latency, API calls, cache events, business events), query functions (summaries, percentiles, cache hit rates, cost by endpoint), dashboard summary, and cleanup job. Added metrics and metricsAggregates tables to schema. Cron job runs daily for 7-day retention cleanup. Awaiting parent epic closure.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:23:30.820432Z","created_by":"osekkat","updated_at":"2026-01-27T11:34:32.260787376Z","closed_at":"2026-01-27T11:34:32.260749600Z","close_reason":"Completed: Comprehensive metrics module with recording functions (latency, API calls, cache events, business events), query functions (summaries, percentiles, cache hit rate, API cost), dashboard summary, and cleanup job. Integrated with service mode for cost monitoring.","compaction_level":0,"original_size":0,"labels":["dashboard","metrics","observability"],"dependencies":[{"issue_id":"foodapp-3uo0ry","depends_on_id":"foodapp-bgdx9l","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-3uo0ry","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-4dxg0z","title":"Implement home page with discovery features","description":"## Task\nBuild the home page - the main entry point for users with discovery features.\n\n## Home Page Sections\n\n### 1. Search Bar (prominent)\n- Autocomplete-enabled search\n- Placeholder: 'Search restaurants, dishes, or guides...'\n- Focus state expands with recent searches\n\n### 2. Near Me Quick Action\n- Prominent button/card\n- Requests geolocation permission\n- Opens map centered on user location\n\n### 3. City Quick-Picks\n- Horizontal scroll of city cards\n- Marrakech, Casablanca, Rabat, Tangier, Fes\n- Each shows thumbnail + place count\n\n### 4. Dish Quick-Picks (NEW from revisions)\n- Tagine, Couscous, Pastilla, Seafood, Coffee, Pastries\n- Links to Dish Explorer filtered by dish\n- Works in degraded mode (owned data)\n\n### 5. Curated Guides\n- 'Best tagine', 'Best cafes', etc.\n- Featured guides for selected city\n- Links to full guide pages\n\n### 6. Featured Place Cards\n- Hand-curated 'iconic' spots\n- Show curated card data (owned)\n- Premium placement\n\n### 7. Trending (authenticated users)\n- Based on recent community activity\n- Popular in selected city\n\n## Component Structure\n```\napp/(main)/page.tsx\n├── SearchHero\n├── NearMeCard\n├── CityPicker\n├── DishQuickPicks\n├── FeaturedGuides\n├── FeaturedPlaces\n└── TrendingSection (auth)\n```\n\n## Data Fetching\n- Cities: static/cached\n- Guides: Convex query (owned)\n- Featured places: Convex query (curated)\n- Trending: Convex query (computed)\n\n## Performance\n- Above-fold content loads first\n- Below-fold lazy loaded\n- Skeleton states for all sections\n\n## Acceptance Criteria\n- [ ] All sections implemented\n- [ ] Search bar with autocomplete integration\n- [ ] City/dish quick-picks working\n- [ ] Featured content displaying\n- [ ] Responsive on mobile","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:24:26.271957Z","created_by":"osekkat","updated_at":"2026-01-27T12:39:34.997845672Z","closed_at":"2026-01-27T12:39:34.997805372Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["core","home","ui"],"dependencies":[{"issue_id":"foodapp-4dxg0z","depends_on_id":"foodapp-1vm307","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-4dxg0z","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-4dxg0z","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-549wnq","title":"Morocco Food Discovery App - i18n & Localization","description":"## Overview\nThis epic implements internationalization for Arabic (RTL), French, and English - the three primary languages for Morocco.\n\n## Language Support\n1. **Arabic (ar)** - RTL layout, primary for many locals\n2. **French (fr)** - Common second language, tourist-friendly\n3. **English (en)** - International tourists\n\n## RTL Layout Considerations\n- Tailwind RTL utilities\n- Component-level RTL testing\n- Map controls positioning\n- Form input direction\n- Navigation flow reversal\n\n## Provider Localization\nProviderGateway applies defaults:\n- `languageCode` from user locale ('ar' | 'fr' | 'en')\n- `regionCode: 'MA'` unless browsing another country\n\nThis ensures provider results match user's language preference.\n\n## Transliteration\nMorocco is multilingual - users might search in different scripts:\n- tagine ↔ tajine ↔ طاجين\n- couscous ↔ كسكس\n\nNormalization happens at:\n- Index time (curated content)\n- Query time (user searches)\n\n## Content Localization\nTables with locale variants:\n- categories (name, nameAr, nameFr)\n- cities (name, nameAr, nameFr)\n- curatedPlaces (locale field)\n- guides (locale field)\n\n## UI String Management\n- Next.js i18n routing\n- JSON translation files per locale\n- Plural rules for AR/FR/EN\n- Date/time formatting by locale\n\n## Testing Requirements\n- E2E tests in all three locales\n- RTL layout verification (Playwright screenshots)\n- Visual regression for RTL vs LTR\n\n## Success Criteria\n- [ ] All UI strings translated to AR/FR/EN\n- [ ] RTL layout working correctly\n- [ ] Transliteration matching variants\n- [ ] Provider results in correct language","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:22:59.539259Z","created_by":"osekkat","updated_at":"2026-01-27T17:58:58.239950058Z","closed_at":"2026-01-27T17:58:58.239893913Z","close_reason":"All child tasks completed: RTL layout, i18n config","compaction_level":0,"original_size":0,"labels":["i18n","localization","p1","rtl"]}
{"id":"foodapp-57o59t","title":"Implement rate limiting system","description":"## Task\nBuild granular rate limiting per action type with different limits for authenticated vs anonymous users.\n\n## Rate Limits Table\n| Action | Authenticated | Anonymous |\n|--------|---------------|-----------|\n| Search | 60/min | 20/min |\n| Place detail | 30/min | 30/min |\n| Review create | 5/hour | N/A |\n| Photo upload | 10/hour | N/A |\n| Report submit | 10/day | N/A |\n| Favorite toggle | 60/min | N/A |\n| Tag vote | 30/min | 10/min |\n\n## Schema\n```typescript\nrateLimits: defineTable({\n  key: v.string(),        // 'user:{userId}:search' or 'ip:{ip}:search'\n  windowStart: v.number(),\n  count: v.number(),\n}).index('by_key', ['key']),\n```\n\n## Implementation\n```typescript\n// convex/rateLimit.ts\ninterface RateLimitConfig {\n  window: number;  // milliseconds\n  limit: number;\n}\n\nconst LIMITS: Record<string, { auth: RateLimitConfig; anon: RateLimitConfig }> = {\n  search: {\n    auth: { window: 60000, limit: 60 },\n    anon: { window: 60000, limit: 20 },\n  },\n  place_detail: {\n    auth: { window: 60000, limit: 30 },\n    anon: { window: 60000, limit: 30 },\n  },\n  review_create: {\n    auth: { window: 3600000, limit: 5 },\n    anon: { window: 0, limit: 0 }, // Not allowed\n  },\n  // ...\n};\n\nexport async function checkRateLimit(\n  ctx: MutationCtx | ActionCtx,\n  action: string,\n  identifier: { userId?: string; ip?: string }\n): Promise<{ allowed: boolean; remaining: number; resetAt: number }> {\n  const isAuth = !!identifier.userId;\n  const config = LIMITS[action]?.[isAuth ? 'auth' : 'anon'];\n  \n  if (!config || config.limit === 0) {\n    return { allowed: false, remaining: 0, resetAt: 0 };\n  }\n  \n  const key = identifier.userId\n    ? `user:${identifier.userId}:${action}`\n    : `ip:${identifier.ip}:${action}`;\n  \n  const now = Date.now();\n  const existing = await ctx.db\n    .query('rateLimits')\n    .withIndex('by_key', (q) => q.eq('key', key))\n    .unique();\n  \n  if (!existing || existing.windowStart + config.window < now) {\n    // New window\n    await ctx.db.insert('rateLimits', {\n      key,\n      windowStart: now,\n      count: 1,\n    });\n    return { allowed: true, remaining: config.limit - 1, resetAt: now + config.window };\n  }\n  \n  if (existing.count >= config.limit) {\n    return {\n      allowed: false,\n      remaining: 0,\n      resetAt: existing.windowStart + config.window,\n    };\n  }\n  \n  await ctx.db.patch(existing._id, { count: existing.count + 1 });\n  return {\n    allowed: true,\n    remaining: config.limit - existing.count - 1,\n    resetAt: existing.windowStart + config.window,\n  };\n}\n```\n\n## Usage Pattern\n```typescript\nexport const searchPlaces = action({\n  args: { query: v.string() },\n  handler: async (ctx, args) => {\n    const userId = await getAuthUserId(ctx);\n    const ip = getClientIP(ctx);\n    \n    const limit = await checkRateLimit(ctx, 'search', { userId, ip });\n    if (!limit.allowed) {\n      throw new ConvexError({\n        code: 'RATE_LIMITED',\n        message: `Too many requests. Try again in ${Math.ceil((limit.resetAt - Date.now()) / 1000)}s`,\n      });\n    }\n    \n    // Proceed with search...\n  },\n});\n```\n\n## Acceptance Criteria\n- [ ] Per-action limits enforced\n- [ ] Different limits for auth vs anon\n- [ ] Clear error messages with reset time\n- [ ] Rate limit headers in responses","notes":"Implementation complete by CyanCrane (2026-01-27): Added rateLimit.ts with checkRateLimit, getRateLimitStatus, enforceRateLimit functions. Limits defined for search, autocomplete, place_detail, review_create, photo_upload, report_submit, favorite_toggle, tag_vote actions. Different limits for auth vs anon. Cleanup cron added for daily purge. Awaiting parent epic closure.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T18:57:10.558177Z","created_by":"osekkat","updated_at":"2026-01-27T13:52:37.347068702Z","closed_at":"2026-01-27T13:52:37.347003645Z","compaction_level":0,"original_size":0,"labels":["rate-limiting","security","trust"],"dependencies":[{"issue_id":"foodapp-57o59t","depends_on_id":"foodapp-b49xc1","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-57o59t","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-5hwtg9","title":"Implement Content Security Policy and security headers","description":"## Task\nConfigure strict security headers including CSP that works with Google Maps JS.\n\n## Security Headers to Configure\n\n### Content-Security-Policy\nMust allow Google Maps JS while blocking other vectors:\n```typescript\nconst csp = {\n  'default-src': [\"'self'\"],\n  'script-src': [\n    \"'self'\",\n    \"'unsafe-inline'\", // Required for Maps JS\n    'https://maps.googleapis.com',\n    'https://maps.gstatic.com',\n  ],\n  'style-src': [\n    \"'self'\",\n    \"'unsafe-inline'\", // Required for Maps JS\n    'https://fonts.googleapis.com',\n  ],\n  'img-src': [\n    \"'self'\",\n    'data:',\n    'blob:',\n    'https://maps.googleapis.com',\n    'https://maps.gstatic.com',\n    'https://*.convex.cloud', // Convex storage\n  ],\n  'font-src': [\"'self'\", 'https://fonts.gstatic.com'],\n  'connect-src': [\n    \"'self'\",\n    'https://maps.googleapis.com',\n    'https://*.convex.cloud',\n    process.env.NEXT_PUBLIC_CONVEX_URL,\n  ],\n  'frame-ancestors': [\"'none'\"],\n  'base-uri': [\"'self'\"],\n  'form-action': [\"'self'\"],\n};\n```\n\n### Other Headers\n```typescript\n// next.config.js\nconst securityHeaders = [\n  {\n    key: 'X-Content-Type-Options',\n    value: 'nosniff',\n  },\n  {\n    key: 'X-Frame-Options',\n    value: 'DENY',\n  },\n  {\n    key: 'X-XSS-Protection',\n    value: '1; mode=block',\n  },\n  {\n    key: 'Referrer-Policy',\n    value: 'strict-origin-when-cross-origin',\n  },\n  {\n    key: 'Permissions-Policy',\n    value: 'camera=(), microphone=(), geolocation=(self)',\n  },\n];\n```\n\n## next.config.js Configuration\n```javascript\n// next.config.js\nmodule.exports = {\n  async headers() {\n    return [\n      {\n        source: '/:path*',\n        headers: [\n          ...securityHeaders,\n          {\n            key: 'Content-Security-Policy',\n            value: buildCSP(csp),\n          },\n        ],\n      },\n      // Provider-backed routes: no caching\n      {\n        source: '/place/g/:path*',\n        headers: [\n          { key: 'Cache-Control', value: 'no-store, must-revalidate' },\n        ],\n      },\n    ];\n  },\n};\n```\n\n## Disable Caching on Provider Routes\nCritical for compliance:\n```typescript\n// app/place/g/[placeId]/page.tsx\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n```\n\n## Bot Protection (Future)\nAdd progressive challenges for high-cost endpoints:\n- Captcha on suspicious patterns\n- Rate limit by IP\n- Block known bad actors\n\n## Testing\n- Verify Maps JS loads correctly with CSP\n- Verify XSS attempts blocked\n- Verify provider routes have no-store\n\n## Acceptance Criteria\n- [ ] CSP configured and enforced\n- [ ] Maps JS working with CSP\n- [ ] Security headers on all routes\n- [ ] Provider routes have no-store\n- [ ] No CSP violations in console","notes":"Starting implementation - ClaudeOpus agent","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:37:45.751980Z","created_by":"osekkat","updated_at":"2026-01-27T15:46:04.019292670Z","closed_at":"2026-01-27T15:46:04.019261043Z","close_reason":"CSP and security headers fully implemented in next.config.ts including Google Maps JS support, HSTS, XSS protection, frame options, referrer policy, and permissions policy","compaction_level":0,"original_size":0,"labels":["csp","headers","security"],"dependencies":[{"issue_id":"foodapp-5hwtg9","depends_on_id":"foodapp-cmnis6","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-5hwtg9","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-5pga4a","title":"Set up CI/CD pipeline with compliance gates","description":"## Task\nConfigure GitHub Actions CI/CD pipeline with compliance tests as mandatory gates.\n\n## Pipeline Stages\n\n### 1. Lint & Type Check (Fast Fail)\n```yaml\n- name: Lint & Type Check\n  run: |\n    npm run lint\n    npm run typecheck\n```\n\n### 2. Unit Tests\n```yaml\n- name: Unit Tests\n  run: npm run test:coverage\n```\n\n### 3. Compliance Tests (GATE)\n**Must pass or deployment blocked:**\n```yaml\n- name: Compliance Tests\n  run: npm run test:compliance\n  # These tests verify:\n  # - No provider content in persistence\n  # - No provider content in analytics\n  # - Provider routes are no-store\n  # - No provider content in Sentry config\n```\n\n### 4. Integration Tests\n```yaml\n- name: Integration Tests\n  run: npm run test:integration\n```\n\n### 5. E2E Tests\n```yaml\n- name: E2E Tests\n  run: npm run test:e2e\n```\n\n### 6. Deploy to Staging\n```yaml\n- name: Deploy to Staging\n  if: github.ref == 'refs/heads/main'\n  run: vercel deploy --prebuilt\n```\n\n### 7. Canary Tests\n```yaml\n- name: Canary Tests\n  run: npm run test:canary -- --env staging\n```\n\n### 8. Deploy to Production\n```yaml\n- name: Deploy to Production\n  if: github.ref == 'refs/heads/main'\n  environment: production\n  run: vercel deploy --prebuilt --prod\n```\n\n## Full Workflow File\n```yaml\n# .github/workflows/ci.yml\nname: CI/CD\n\non:\n  push:\n    branches: [main]\n  pull_request:\n    branches: [main]\n\njobs:\n  lint:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n          cache: 'npm'\n      - run: npm ci\n      - run: npm run lint\n      - run: npm run typecheck\n\n  test:\n    needs: lint\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n          cache: 'npm'\n      - run: npm ci\n      - run: npm run test:coverage\n      - name: Compliance Tests (GATE)\n        run: npm run test:compliance\n\n  e2e:\n    needs: test\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n      - run: npm ci\n      - run: npx playwright install --with-deps\n      - run: npm run test:e2e\n\n  deploy-staging:\n    needs: e2e\n    if: github.ref == 'refs/heads/main'\n    runs-on: ubuntu-latest\n    environment: staging\n    steps:\n      - uses: actions/checkout@v4\n      - uses: amondnet/vercel-action@v20\n        with:\n          vercel-token: ${{ secrets.VERCEL_TOKEN }}\n          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}\n          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}\n\n  deploy-production:\n    needs: deploy-staging\n    if: github.ref == 'refs/heads/main'\n    runs-on: ubuntu-latest\n    environment: production\n    steps:\n      - uses: actions/checkout@v4\n      - uses: amondnet/vercel-action@v20\n        with:\n          vercel-token: ${{ secrets.VERCEL_TOKEN }}\n          vercel-args: '--prod'\n```\n\n## Target: <15min Total Pipeline\n\n## Acceptance Criteria\n- [ ] Pipeline runs on every PR\n- [ ] Compliance tests blocking bad merges\n- [ ] Staging deploys automatically\n- [ ] Production requires manual approval\n- [ ] Pipeline time <15 minutes","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T18:58:08.778158Z","created_by":"osekkat","updated_at":"2026-01-27T17:14:56.353086657Z","closed_at":"2026-01-27T17:14:56.353013087Z","compaction_level":0,"original_size":0,"labels":["automation","ci-cd","devops"],"dependencies":[{"issue_id":"foodapp-5pga4a","depends_on_id":"foodapp-5ytdb3","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-5pga4a","depends_on_id":"foodapp-dzoupr","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-5pga4a","depends_on_id":"foodapp-tuvm91","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-5ytdb3","title":"Morocco Food Discovery App - Testing & CI/CD","description":"## Overview\nThis epic implements the testing strategy and CI/CD pipeline, with special emphasis on compliance regression tests that prevent accidental policy violations.\n\n## Test Types\n\n### Unit Tests (Vitest)\n- Provider mapping + response transformation\n- Caching logic (stale detection, TTL)\n- Transliteration/search normalization\n- Rate limit calculations\n- Geohash encoding/decoding\n\n### Compliance Regression Tests (MUST-HAVE)\n**These are CI gates - failures block deployment.**\n\n1. Tests verifying provider response objects are NEVER written to Convex tables\n2. Tests verifying analytics payload builders reject provider content fields\n3. Tests verifying Next.js provider-backed routes are configured as no-store\n\n### Contract Tests (Provider Field Sets)\nFor each approved field set:\n- Mapping layer handles missing fields safely\n- No extra fields requested beyond UI needs\n\n### Integration Tests (Convex test framework)\n- Review/list mutations with aggregate updates\n- Rate limiting enforcement\n- Auth flows\n- Search with filters\n\n### E2E Tests (Playwright)\n- Critical flows: search → place → favorite → review\n- RTL layout verification (Arabic)\n- Mobile responsive breakpoints\n- Offline behavior (service worker)\n\n### Accessibility Tests (axe-core)\n- WCAG 2.1 AA compliance\n- Screen reader navigation\n- Keyboard navigation\n- Color contrast (all themes)\n\n### Visual Regression (Playwright screenshots)\n- Component library in all locales\n- RTL vs LTR layouts\n- Mobile vs desktop\n\n### Load Tests (k6/Artillery)\n- 1000 concurrent users searching\n- Google API call amplification\n- Rate limiting under load\n- Cache behavior under pressure\n\n## Mocking Strategy\n- MSW for Google API in dev/test\n- Seed database: 100 places, 500 reviews\n- Fixtures for common API responses\n- Error simulation for resilience testing\n\n## CI/CD Pipeline\n1. **Lint + Type check** - Fast fail\n2. **Unit tests** - Vitest\n3. **Compliance tests** - CI gate\n4. **Integration tests** - Convex\n5. **E2E tests** - Playwright (headless)\n6. **Visual regression** - Screenshot diff\n7. **Deploy to staging** - Vercel preview\n8. **Canary tests** - Against staging\n9. **Deploy to production** - Manual approval\n\n## Success Criteria\n- [ ] All test types implemented\n- [ ] Compliance tests blocking bad deploys\n- [ ] CI/CD pipeline fully automated\n- [ ] <15 min total pipeline time","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:23:17.664882Z","created_by":"osekkat","updated_at":"2026-01-27T17:58:58.277454254Z","closed_at":"2026-01-27T17:58:58.277422607Z","close_reason":"All child tasks completed: CI/CD pipeline, testing infrastructure","compaction_level":0,"original_size":0,"labels":["ci-cd","compliance","p1","testing"]}
{"id":"foodapp-6e5efz","title":"Implement Google Maps integration with clustering","description":"## Task\nSet up Google Maps JavaScript API integration with marker clustering for performance.\n\n## Installation\n```bash\nnpm install @react-google-maps/api\n```\n\n## Core Components\n\n### MapProvider\n```typescript\n// components/providers/MapProvider.tsx\nimport { LoadScript } from '@react-google-maps/api';\n\nexport function MapProvider({ children }) {\n  return (\n    <LoadScript\n      googleMapsApiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_KEY}\n      libraries={['places', 'marker']}\n    >\n      {children}\n    </LoadScript>\n  );\n}\n```\n\n### MapView Component\n```typescript\n// components/maps/MapView.tsx\nimport { GoogleMap, MarkerClusterer } from '@react-google-maps/api';\n\nexport function MapView({ places, onBoundsChange }) {\n  return (\n    <GoogleMap\n      center={defaultCenter}\n      zoom={13}\n      onBoundsChanged={handleBoundsChange}\n    >\n      <MarkerClusterer>\n        {(clusterer) =>\n          places.map((place) => (\n            <PlaceMarker\n              key={place.placeKey}\n              place={place}\n              clusterer={clusterer}\n            />\n          ))\n        }\n      </MarkerClusterer>\n    </GoogleMap>\n  );\n}\n```\n\n## Clustering Configuration\n- Enable when >50 markers visible\n- Custom cluster icons with count\n- Cluster click → zoom in OR show list\n\n## Performance Optimizations\n- Marker recycling (reuse instead of create/destroy)\n- Throttle marker updates (max 1/100ms during pan)\n- Lazy load map component\n- Only render visible markers\n\n## Map Styles\n- Custom style JSON for Moroccan aesthetic\n- Support dark mode variant\n- Minimal labels in clustered view\n\n## Acceptance Criteria\n- [ ] Map rendering correctly\n- [ ] Clustering working with many markers\n- [ ] Custom markers displaying\n- [ ] Performance smooth during pan/zoom","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:30:31.131236Z","created_by":"osekkat","updated_at":"2026-01-27T15:50:03.822313829Z","closed_at":"2026-01-27T15:50:03.822262572Z","close_reason":"Completed: Fixed TypeScript errors in MapView.tsx and PlaceMarker.tsx (replaced invalid google.maps.MarkerClusterer type with Clusterer from library, removed unsupported optimized prop). All acceptance criteria met: MapProvider, MapView with clustering, PlaceMarker with color-coding, throttled bounds updates, Moroccan-themed styles.","compaction_level":0,"original_size":0,"labels":["google-maps","map","ui"],"dependencies":[{"issue_id":"foodapp-6e5efz","depends_on_id":"foodapp-8q1iji","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-6e5efz","depends_on_id":"foodapp-ep42ns","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-6e5efz","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-6ilp76","title":"Implement UGC photo upload with moderation pipeline","description":"## Task\nBuild the UGC photo upload system with full moderation pipeline (EXIF stripping, NSFW detection, approval flow).\n\n## Upload Flow\n```\nUser selects photo(s)\n    ↓\nClient-side validation (size, type)\n    ↓\nUpload to Convex storage\n    ↓\nCreate ugcPhotos record (status: pending)\n    ↓\nTrigger moderation action:\n  1. Strip EXIF metadata\n  2. Generate thumbnail + blurhash\n  3. Calculate perceptual hash\n  4. Call Cloud Vision SafeSearch\n    ↓\nAuto-approve if clean, hold if flagged\n```\n\n## ugcPhotos Schema\n```typescript\nugcPhotos: defineTable({\n  uploaderUserId: v.id('users'),\n  placeKey: v.string(),\n  reviewId: v.optional(v.id('reviews')),\n  storageId: v.id('_storage'),\n  moderationStatus: v.string(), // 'pending' | 'approved' | 'rejected'\n  nsfwScore: v.optional(v.number()),\n  width: v.optional(v.number()),\n  height: v.optional(v.number()),\n  blurhash: v.optional(v.string()),\n  perceptualHash: v.optional(v.string()),\n  exifStripped: v.boolean(),\n  createdAt: v.number(),\n})\n```\n\n## EXIF Stripping\nPrivacy critical - remove:\n- GPS coordinates\n- Device info\n- Timestamps\n- Any identifying metadata\n\nUse sharp or similar library in Convex action.\n\n## Blurhash Generation\nFor loading placeholders:\n```typescript\nimport { encode } from 'blurhash';\nconst blurhash = encode(imageData, width, height, 4, 3);\n```\n\n## Perceptual Hash\nFor duplicate/spam detection:\n- Calculate phash of resized thumbnail\n- Store for comparison\n- Flag if matches recently uploaded photos from different users\n\n## NSFW Detection\n```typescript\n// Call Google Cloud Vision SafeSearch\nconst result = await vision.safeSearchDetection(imageUri);\nconst nsfwScore = calculateNsfwScore(result.safeSearchAnnotation);\n\nif (nsfwScore > NSFW_THRESHOLD) {\n  await holdForModeration(photoId);\n} else {\n  await autoApprove(photoId);\n}\n```\n\n## Constraints\n- Max 5 photos per review\n- Max 10MB per photo\n- JPEG/PNG/WebP only\n\n## Acceptance Criteria\n- [ ] Upload working with validation\n- [ ] EXIF stripped on all photos\n- [ ] Blurhash generated\n- [ ] NSFW detection triggering holds\n- [ ] Moderation queue queryable","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:32:05.053628Z","created_by":"osekkat","updated_at":"2026-01-27T17:55:05.521713287Z","closed_at":"2026-01-27T17:55:05.521662241Z","close_reason":"Implemented UGC photo upload with moderation pipeline: upload mutations, EXIF stripping, blurhash, NSFW detection, moderation queue","compaction_level":0,"original_size":0,"labels":["moderation","photos","ugc"],"dependencies":[{"issue_id":"foodapp-6ilp76","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-6ilp76","depends_on_id":"foodapp-tpsmbw","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-7yjl4v","title":"Morocco Food Discovery App - User Features & Collaborative Lists","description":"## Overview\nThis epic implements user accounts, lists, favorites, and the new collaborative itinerary feature that leverages Convex's real-time capabilities.\n\n## Authentication\nUsing Convex Auth:\n- Google OAuth (primary)\n- Email/password (fallback)\n- Apple (future)\n\nUser profile stores:\n- Basic info + avatar\n- Locale preference (ar/fr/en)\n- Contribution stats for reputation\n\n## Lists & Favorites\nThree list types:\n1. **Favorites** - Default list, quick save\n2. **Custom lists** - User-created collections\n3. **Itineraries** - Ordered food crawls with time slots\n\n### Collaborative Lists (New)\nConvex gives us real-time collaboration 'for free'. We're adding:\n- Viewer/editor roles per collaborator\n- Invite codes with expiration\n- Real-time sync: reorder + notes sync instantly\n\n**Why this matters**:\n- High retention (people plan together)\n- Natural growth (shares)\n- All owned data (policy-safe)\n\n### Schema Additions\n```typescript\nlistCollaborators: defineTable({\n  listId: v.id('lists'),\n  userId: v.id('users'),\n  role: v.string(), // 'owner' | 'editor' | 'viewer'\n  createdAt: v.number(),\n})\n\nlistInvites: defineTable({\n  listId: v.id('lists'),\n  inviteCode: v.string(),\n  role: v.string(), // 'editor' | 'viewer'\n  createdByUserId: v.id('users'),\n  createdAt: v.number(),\n  expiresAt: v.number(),\n})\n```\n\n## Food Crawl / Itinerary Features\n- Drag-and-drop ordering\n- Time slots (breakfast/lunch/dinner)\n- 'Start here' + 'walk/drive to next' deep links\n- Per-stop notes\n\n## User Preferences\n- Analytics opt-out\n- Default city\n- Map style\n- Distance unit (km/mi)\n\n## V2 Notifications (Revised)\nOriginal plan had 'saved place status changes' - problematic because it requires persisting provider state.\n\n**New approach** - notifications for owned signals only:\n- New guide drops\n- New reviews on saved places\n- Collaborator edits\n- Editorial updates\n\n## Success Criteria\n- [ ] Auth working with Google OAuth\n- [ ] Lists with CRUD and sharing\n- [ ] Collaborative editing real-time sync\n- [ ] Itineraries with ordering and time slots","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:22:58.386719Z","created_by":"osekkat","updated_at":"2026-01-27T17:58:33.842509Z","closed_at":"2026-01-27T17:58:33.842470342Z","close_reason":"All child tasks completed: user profile page, collaborative lists, list types","compaction_level":0,"original_size":0,"labels":["auth","collaboration","lists","p1","users"]}
{"id":"foodapp-83tb1i","title":"Set up Convex Auth with Google OAuth","description":"## Task\nConfigure Convex Auth for user authentication with Google OAuth as primary provider.\n\n## Commands\n```bash\nnpm install @convex-dev/auth @auth/core\n```\n\n## Configuration Steps\n1. Create Google Cloud OAuth credentials\n2. Configure Convex Auth in convex/auth.ts\n3. Set up auth environment variables in Convex dashboard\n4. Create auth provider components\n\n## OAuth Providers\n- **Google OAuth** (primary) - Most users have Google accounts\n- **Email/password** (fallback) - For users without Google\n- Apple (future consideration)\n\n## Security Considerations\n- Use secure session handling\n- Implement CSRF protection\n- Token refresh handling\n- Secure logout flow\n\n## Files to Create\n- convex/auth.ts - Auth configuration\n- components/providers/AuthProvider.tsx - React context\n- app/(auth)/login/page.tsx - Login page\n- app/(auth)/callback/page.tsx - OAuth callback\n\n## Acceptance Criteria\n- [ ] Google OAuth flow working\n- [ ] User session persisted\n- [ ] Logout working\n- [ ] Auth state available in components","notes":"Convex dev runs clean with auth config (convex dev --once). OAuth flow still needs manual browser verification (login redirect + session + sign out).","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:23:51.957743Z","created_by":"osekkat","updated_at":"2026-01-27T12:56:57.009071137Z","closed_at":"2026-01-27T12:56:57.008985309Z","close_reason":"Completed: AuthProvider uses ConvexAuthNextjsProvider, sign-in page has Google OAuth button, profile page has sign-out, auth state available via useConvexAuth. OAuth credentials need to be configured in Convex dashboard.","compaction_level":0,"original_size":0,"labels":["auth","setup"],"dependencies":[{"issue_id":"foodapp-83tb1i","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-83tb1i","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-87mxxx","title":"Implement ID-only map tile cache","description":"## Task\nImplement the mapTileCache for storing place IDs per viewport tile (policy-safe, no provider content).\n\n## Why Tile-Based Caching\nMap pans generate lots of 'search this area' calls. Without caching:\n- Every pan → provider call\n- Multiple users panning same area → multiplied calls\n- Popular areas (Jemaa el-Fna) get hammered\n\n## Tile System\nUse S2 or geohash cells:\n- Zoom-derived granularity (coarser at low zoom)\n- Predictable tile keys\n- Efficient spatial queries\n\n```typescript\nfunction getTileKey(lat: number, lng: number, zoom: number): string {\n  const precision = zoomToPrecision(zoom);\n  const s2Cell = S2.latLngToCell(lat, lng, precision);\n  return `s2:${precision}:${s2Cell.id()}`;\n}\n```\n\n## Schema\n```typescript\nmapTileCache: defineTable({\n  tileKey: v.string(),           // e.g. 's2:12:89ab...'\n  zoom: v.number(),\n  chunk: v.number(),             // 0..N for large tiles\n  provider: v.string(),          // 'google'\n  placeKeys: v.array(v.string()),// ID-only\n  expiresAt: v.number(),\n  createdAt: v.number(),\n})\n  .index('by_tile', ['tileKey', 'zoom', 'chunk'])\n  .index('by_expiry', ['expiresAt']),\n```\n\n## Chunking\nLarge tiles (zoomed out) might have 1000+ places. Chunk to avoid oversized documents:\n- Max 100 placeKeys per chunk\n- Query all chunks for a tile\n- Write new chunks as needed\n\n## Cache Flow\n```\nMap bounds change\n    ↓\nCalculate visible tiles\n    ↓\nCheck client seenTiles set (already loaded?)\n    ↓\nFor unseen tiles: query mapTileCache\n    ↓\nHIT: Use cached placeKeys → fetch fresh details for visible\nMISS: Call provider (bounded search) → cache placeKeys → return\n```\n\n## TTL Strategy\n- 30-60 minute TTL\n- Longer than search cache (places don't move)\n\n## Acceptance Criteria\n- [ ] Tile key generation correct\n- [ ] Cache hits working\n- [ ] Chunking handling large tiles\n- [ ] Cache reducing provider calls >70%","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:30:53.957319Z","created_by":"osekkat","updated_at":"2026-01-27T17:04:13.429817636Z","closed_at":"2026-01-27T17:04:13.429768912Z","close_reason":"Implemented ID-only map tile cache with geohash-based tiles, chunking support, TTL, and cron purge job. Integrated with useMapSearch hook.","compaction_level":0,"original_size":0,"labels":["caching","geospatial","map"],"dependencies":[{"issue_id":"foodapp-87mxxx","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-87mxxx","depends_on_id":"foodapp-ep42ns","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-87mxxx","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-8fw7nv","title":"Configure environment separation (dev/staging/prod)","description":"## Task\nSet up proper environment separation to prevent accidents and enable safe testing.\n\n## Environments\n\n### Development\n- Local Convex dev instance\n- Google API keys with low quotas\n- MSW mocking for most provider calls\n- Hot reload, verbose logging\n\n### Staging\n- Separate Convex project\n- Separate Google API keys (still restricted)\n- Real provider calls but monitored\n- Preview deployments on Vercel\n\n### Production\n- Production Convex project\n- Production Google API keys with full quotas\n- Budget alerts active\n- Error budget tracking\n\n## Environment Variables Pattern\n```\n# .env.local (dev)\nNEXT_PUBLIC_CONVEX_URL=https://xxx.convex.dev\nNEXT_PUBLIC_GOOGLE_MAPS_KEY=...\nGOOGLE_PLACES_KEY=...\n\n# Vercel env vars (staging/prod)\n# Set separately per environment\n```\n\n## Key Principle\nNEVER share API keys between environments. A staging incident shouldn't affect production budget.\n\n## Convex Environment Setup\n1. Create separate Convex projects: morocco-eats-dev, morocco-eats-staging, morocco-eats-prod\n2. Use Convex dashboard to manage env vars per project\n\n## Vercel Configuration\n- Preview branches → staging Convex\n- Main branch → production Convex\n- Environment variables per deployment target\n\n## Acceptance Criteria\n- [ ] Three environments properly isolated\n- [ ] No shared API keys\n- [ ] Vercel deployment targets configured\n- [ ] Convex projects separated","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:24:34.283077Z","created_by":"osekkat","updated_at":"2026-01-27T17:50:50.211275738Z","closed_at":"2026-01-27T17:50:50.211229560Z","close_reason":"Implemented environment separation: vercel.json, .env.example documentation, lib/env.ts validation","compaction_level":0,"original_size":0,"labels":["devops","environments","setup"],"dependencies":[{"issue_id":"foodapp-8fw7nv","depends_on_id":"foodapp-8q1iji","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-8fw7nv","depends_on_id":"foodapp-oec6mt","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-8fw7nv","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-8m9gg2","title":"Set up Sentry for error tracking with provider content redaction","description":"## Task\nConfigure Sentry for observability with critical safeguards to prevent provider content from appearing in error reports.\n\n## Commands\n```bash\nnpm install @sentry/nextjs\nnpx @sentry/wizard@latest -i nextjs\n```\n\n## Why Redaction is Critical\nProvider content (place names, addresses, ratings) must NEVER appear in:\n- Error messages\n- Breadcrumbs\n- Context data\n- Stack traces\n\nThis is a policy compliance requirement, not optional.\n\n## Configuration\n```typescript\n// sentry.client.config.ts\nSentry.init({\n  beforeSend(event) {\n    // Redact any provider content from error\n    return redactProviderContent(event);\n  },\n  beforeBreadcrumb(breadcrumb) {\n    // Filter breadcrumbs that might contain provider data\n    if (breadcrumb.category === 'fetch') {\n      // Redact URLs/bodies for provider endpoints\n    }\n    return breadcrumb;\n  },\n});\n```\n\n## Redaction Patterns\n- Any data from places.googleapis.com responses\n- Photo references in URLs\n- Place details (name, address, phone, etc.)\n\n## What IS Allowed\n- placeKey / place_id (identifiers only)\n- Error codes and status\n- Latency measurements\n- User IDs (if consented)\n\n## Acceptance Criteria\n- [ ] Sentry capturing errors\n- [ ] beforeSend redaction working\n- [ ] Breadcrumb filtering working\n- [ ] Test that provider content doesn't appear","notes":"Starting implementation - ClaudeOpus agent","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:24:23.036400Z","created_by":"osekkat","updated_at":"2026-01-27T13:12:33.086206323Z","closed_at":"2026-01-27T13:12:33.086164550Z","close_reason":"Implemented Sentry error tracking with provider content redaction. Created sentry.client.config.ts, sentry.server.config.ts, sentry.edge.config.ts with beforeSend/beforeBreadcrumb hooks that scrub displayName, formattedAddress, phone numbers, ratings, reviews from all events. Added instrumentation.ts for Next.js 15+ integration. All 117 tests pass.","compaction_level":0,"original_size":0,"labels":["compliance","observability","sentry"],"dependencies":[{"issue_id":"foodapp-8m9gg2","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-8m9gg2","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-8q1iji","title":"Configure Google Cloud Console with dual API keys","description":"## Task\nSet up Google Cloud project with properly separated API keys for browser vs server usage.\n\n## Why Dual Keys\nSecurity best practice - different restrictions for different contexts:\n\n### Browser Key (Maps JS API)\n- HTTP referrer restrictions (your domains only)\n- Only enables Maps JavaScript API\n- Can be exposed in client bundle (restricted)\n\n### Server Key (Places API)\n- IP restrictions OR no restrictions (server-only)\n- Enables Places API (New)\n- NEVER in client bundle\n- Stored in Convex env + Next.js server env only\n\n## Configuration Steps\n1. Create Google Cloud project\n2. Enable APIs:\n   - Maps JavaScript API\n   - Places API (New)\n3. Create Browser API key with referrer restrictions\n4. Create Server API key\n5. Set quotas and budget alerts\n\n## Quota Recommendations (Day 1)\n- Places API: Start conservative, increase based on actual usage\n- Set daily budget cap with alerts at 50%, 80%, 100%\n\n## Environment Variables\n```\n# Client-side (public)\nNEXT_PUBLIC_GOOGLE_MAPS_KEY=...\n\n# Server-side (secret)\nGOOGLE_PLACES_KEY=...  # In Convex env\n```\n\n## Acceptance Criteria\n- [ ] Both API keys created and working\n- [ ] Browser key restricted to domains\n- [ ] Server key stored securely\n- [ ] Budget alerts configured\n- [ ] Quotas set appropriately","notes":"Configuration complete (2026-01-27): Browser key (NEXT_PUBLIC_GOOGLE_MAPS_API_KEY) added to .env.local, Server key (GOOGLE_PLACES_KEY) added to Convex environment variables. Ready for Maps JS and Places API integration.","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:24:02.480186Z","created_by":"osekkat","updated_at":"2026-01-27T15:23:08.395321005Z","closed_at":"2026-01-27T15:23:08.395248758Z","compaction_level":0,"original_size":0,"labels":["api-keys","google","security"],"dependencies":[{"issue_id":"foodapp-8q1iji","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-99njj0","title":"Implement ProviderGateway wrapper with field mask registry","description":"## Task\nCreate the central ProviderGateway that all provider access flows through. This is the enforcement point for policy compliance.\n\n## Why Central Gateway\nWithout a single gateway:\n- Budget/rate limits can be bypassed\n- Logging might capture provider content differently\n- Feature flags might not be respected consistently\n\n## Core Responsibilities\n1. **Field mask registry** - Only pre-approved masks, no ad-hoc\n2. **Budget enforcement** - Per-endpoint class limits\n3. **Circuit breaker integration** - Respect breaker state\n4. **Metrics emission** - Latency, error code, cost class, cache outcome\n5. **Response redaction** - Strip provider content from logs/errors\n6. **Localization defaults** - languageCode, regionCode\n\n## Field Mask Registry\n```typescript\n// convex/fieldSets.ts\nexport const FIELD_SETS = {\n  SEARCH_LITE: 'id,displayName,location',\n  PLACE_HEADER: 'id,displayName,formattedAddress,location',\n  PLACE_DETAILS_FULL: 'id,displayName,formattedAddress,location,regularOpeningHours,...',\n  HEALTH_CHECK: 'id',\n} as const;\n```\n\n## Gateway Interface\n```typescript\n// convex/providerGateway.ts\nexport async function providerRequest<T>(\n  ctx: ActionCtx,\n  endpoint: ProviderEndpoint,\n  params: ProviderParams,\n  options: GatewayOptions\n): Promise<ProviderResult<T>> {\n  // 1. Check feature flags\n  // 2. Check budget\n  // 3. Check circuit breaker\n  // 4. Apply field mask from registry\n  // 5. Apply localization defaults\n  // 6. Execute with timeout\n  // 7. Emit metrics\n  // 8. Return (never log response body)\n}\n```\n\n## Localization Defaults\n- languageCode: from user locale ('ar' | 'fr' | 'en')\n- regionCode: 'MA' unless browsing another country\n\n## Acceptance Criteria\n- [ ] All provider calls go through gateway\n- [ ] Field masks from registry only\n- [ ] Metrics emitted for every call\n- [ ] Response bodies never logged","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:25:36.064706Z","created_by":"osekkat","updated_at":"2026-01-27T10:14:24.517007489Z","closed_at":"2026-01-27T10:14:24.516963934Z","close_reason":"Implemented in convex/providerGateway.ts and convex/fieldSets.ts - gateway enforces field mask registry, budget limits, circuit breaker, localization defaults, and response redaction.","compaction_level":0,"original_size":0,"labels":["core","gateway","policy"],"dependencies":[{"issue_id":"foodapp-99njj0","depends_on_id":"foodapp-dpikri","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-99njj0","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-9odm82","title":"Implement RBAC for admin and moderation","description":"## Task\nBuild role-based access control for admin, moderator, and editor roles with audit logging.\n\n## Roles\n- **admin**: Full access, user management, system settings\n- **moderator**: Review moderation, report handling, user warnings\n- **editor**: Curated content, guides, place cards\n\n## Schema\n```typescript\nuserRoles: defineTable({\n  userId: v.id('users'),\n  role: v.string(), // 'admin' | 'moderator' | 'editor'\n  createdAt: v.number(),\n})\n  .index('by_user', ['userId'])\n  .index('by_role', ['role']),\n\nauditLogs: defineTable({\n  actorUserId: v.id('users'),\n  action: v.string(),\n  targetType: v.string(),\n  targetKey: v.string(),\n  metadata: v.optional(v.string()),\n  createdAt: v.number(),\n}).index('by_actor_recent', ['actorUserId', 'createdAt']),\n```\n\n## Access Control Helpers\n```typescript\n// convex/auth/rbac.ts\nexport async function requireRole(\n  ctx: MutationCtx | QueryCtx,\n  allowedRoles: string[]\n): Promise<{ userId: Id<'users'>; role: string }> {\n  const userId = await requireAuth(ctx);\n  \n  const userRole = await ctx.db\n    .query('userRoles')\n    .withIndex('by_user', (q) => q.eq('userId', userId))\n    .first();\n  \n  if (\\!userRole || \\!allowedRoles.includes(userRole.role)) {\n    throw new ConvexError({\n      code: 'FORBIDDEN',\n      message: 'Insufficient permissions',\n    });\n  }\n  \n  return { userId, role: userRole.role };\n}\n\nexport async function logAction(\n  ctx: MutationCtx,\n  action: string,\n  targetType: string,\n  targetKey: string,\n  metadata?: Record<string, any>\n) {\n  const userId = await requireAuth(ctx);\n  \n  await ctx.db.insert('auditLogs', {\n    actorUserId: userId,\n    action,\n    targetType,\n    targetKey,\n    metadata: metadata ? JSON.stringify(metadata) : undefined,\n    createdAt: Date.now(),\n  });\n}\n```\n\n## Usage in Mutations\n```typescript\nexport const deleteReview = mutation({\n  args: { reviewId: v.id('reviews'), reason: v.string() },\n  handler: async (ctx, { reviewId, reason }) => {\n    // Require moderator or admin\n    const { userId, role } = await requireRole(ctx, ['admin', 'moderator']);\n    \n    const review = await ctx.db.get(reviewId);\n    if (\\!review) throw new Error('Review not found');\n    \n    // Soft delete\n    await ctx.db.patch(reviewId, { deletedAt: Date.now() });\n    \n    // Audit log\n    await logAction(ctx, 'review.softDelete', 'review', reviewId, {\n      reason,\n      reviewPlaceKey: review.placeKey,\n    });\n  },\n});\n```\n\n## Critical Rule\n**NEVER rely on client-side gating only.** All mutations MUST check RBAC server-side.\n\n## Audit Log Viewing\n```typescript\nexport const getAuditLogs = query({\n  args: {\n    actorUserId: v.optional(v.id('users')),\n    targetType: v.optional(v.string()),\n    limit: v.optional(v.number()),\n  },\n  handler: async (ctx, args) => {\n    await requireRole(ctx, ['admin']);\n    \n    let query = ctx.db.query('auditLogs');\n    if (args.actorUserId) {\n      query = query.withIndex('by_actor_recent', (q) =>\n        q.eq('actorUserId', args.actorUserId)\n      );\n    }\n    \n    return query.order('desc').take(args.limit || 100);\n  },\n});\n```\n\n## Acceptance Criteria\n- [ ] Roles enforced server-side\n- [ ] Audit log capturing all privileged actions\n- [ ] Admin can view audit logs\n- [ ] Clear error messages for unauthorized access","notes":"Implementation complete by TealOtter: Created convex/auth/rbac.ts with requireAuth, requireRole, hasRole, getUserRole, logAction helpers. Added getAuthStatus query, getAuditLogs (admin), assignRole/removeRole mutations (admin), listRoleAssignments query. All mutations enforce server-side RBAC checks. Fixed placeDetails.ts TypeScript depth issue with @ts-expect-error workaround.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T18:57:28.421408Z","created_by":"osekkat","updated_at":"2026-01-27T12:11:09.820592012Z","closed_at":"2026-01-27T12:11:09.820529439Z","compaction_level":0,"original_size":0,"labels":["admin","rbac","security"],"dependencies":[{"issue_id":"foodapp-9odm82","depends_on_id":"foodapp-83tb1i","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-9odm82","depends_on_id":"foodapp-b49xc1","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-9odm82","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-a4se02","title":"Implement alerting system","description":"## Task\nSet up alerting based on thresholds defined in the plan.\n\n## Alert Thresholds\n\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| Google API error rate | >5% for 5min | Page on-call, enable degraded mode |\n| Search P95 latency | >2s for 10min | Warning notification |\n| Daily API cost | >$X (configurable) | Alert + emergency throttling |\n| Cache hit rate | <50% for 1hr | Investigate |\n| Review spam flags | >10/hour | Alert moderation team |\n\n## Implementation Options\n1. **Convex cron + webhooks**: Check thresholds periodically, send to Slack/Discord\n2. **Sentry alerts**: Use Sentry's alerting for error rate spikes\n3. **Custom notification system**: Store alerts in Convex, show in admin UI\n\n## Recommended Approach\nCombine Sentry for errors + custom Convex-based alerting for business metrics:\n\n```typescript\n// convex/alerts.ts\nexport const checkAlerts = internalMutation({\n  handler: async (ctx) => {\n    const errorRate = await getRecentErrorRate(ctx, 'google_api', 5);\n    if (errorRate > 0.05) {\n      await sendAlert(ctx, {\n        severity: 'critical',\n        title: 'Google API error rate >5%',\n        action: 'Degraded mode activated',\n      });\n      await ctx.runMutation(internal.serviceMode.setMode, { mode: 2 });\n    }\n    // ... more checks\n  },\n});\n\n// Run every minute\ncrons.interval('check_alerts', { minutes: 1 }, internal.alerts.checkAlerts);\n```\n\n## Acceptance Criteria\n- [ ] All threshold alerts configured\n- [ ] Notifications reaching appropriate channels\n- [ ] Auto-mitigation triggering where specified\n- [ ] Alert history viewable in admin","notes":"Starting implementation - ClaudeOpus agent","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:23:46.312520Z","created_by":"osekkat","updated_at":"2026-01-27T13:22:39.792151670Z","closed_at":"2026-01-27T13:22:39.792092391Z","close_reason":"Implemented alerting system with configurable thresholds. Added alertThresholds, alerts, alertSubscriptions tables to schema. Created alerts.ts with checkAlerts cron (every minute), default thresholds for API error rate (>5%/5min), search P95 latency (>2s/10min), cache hit rate (<50%/1hr), review spam rate (>10/hr). Auto-mitigation triggers service mode changes. Added internal setMode function to serviceMode.ts. All 117 tests pass.","compaction_level":0,"original_size":0,"labels":["alerts","observability","ops"],"dependencies":[{"issue_id":"foodapp-a4se02","depends_on_id":"foodapp-3uo0ry","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-a4se02","depends_on_id":"foodapp-bgdx9l","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-aqm6qo","title":"Implement ID-only search result cache","description":"## Task\nImplement the searchResultCache table to store ID-only results from repeated searches, reducing provider calls.\n\n## Why This is Policy-Safe\nWe store ONLY:\n- Cache key (hash of query + filters)\n- Array of placeKeys ('g:ChIJ...')\n- TTL metadata\n\nWe do NOT store:\n- Place names, addresses, ratings\n- Any provider content fields\n\n## Schema\n```typescript\nsearchResultCache: defineTable({\n  cacheKey: v.string(),          // hash(query+filters+city+lang+mode)\n  provider: v.string(),          // 'google'\n  placeKeys: v.array(v.string()),// ID-only ('g:...' or 'c:...')\n  expiresAt: v.number(),\n  createdAt: v.number(),\n})\n  .index('by_key', ['cacheKey'])\n  .index('by_expiry', ['expiresAt']),\n```\n\n## Cache Key Generation\n```typescript\nfunction searchCacheKey(params: SearchParams): string {\n  const normalized = {\n    query: normalizeQuery(params.query),\n    city: params.city,\n    filters: sortObject(params.filters),\n    language: params.language,\n  };\n  return hash(JSON.stringify(normalized));\n}\n```\n\n## Cache Flow\n```\nSearch request\n    ↓\nCheck searchResultCache by cacheKey\n    ↓\nHIT: Return cached placeKeys → fetch fresh details for top N\nMISS: Call provider → store placeKeys → return\n```\n\n## TTL Strategy\n- Short TTL: 15-30 minutes\n- Reasoning: Place existence doesn't change often, but rankings might\n\n## Cache Purge\nScheduled job (ID-only cache purge) deletes expired entries.\n\n## Metrics\n- search_cache_hit_rate (gauge)\n- search_cache_entries (gauge)\n\n## Acceptance Criteria\n- [ ] Cache key generation deterministic\n- [ ] Cache hits returning placeKeys\n- [ ] TTL expiration working\n- [ ] Purge job cleaning up expired entries","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:27:50.540172Z","created_by":"osekkat","updated_at":"2026-01-27T16:07:39.498671330Z","closed_at":"2026-01-27T16:07:39.498640603Z","close_reason":"Completed: Implemented ID-only search result cache. Created searchCache.ts with: generateSearchCacheKey (deterministic), checkSearchCache (internal query), writeSearchCache (internal mutation), purgeExpiredSearchCache (for cleanup). Integrated into providerGateway text_search with cache check before API call and cache write after success. Added hourly purge cron job. 15-minute TTL for freshness.","compaction_level":0,"original_size":0,"labels":["caching","performance","search"],"dependencies":[{"issue_id":"foodapp-aqm6qo","depends_on_id":"foodapp-il4keg","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-aqm6qo","depends_on_id":"foodapp-inak6c","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-avek76","title":"Configure Next.js i18n with AR/FR/EN support","description":"## Task\nSet up Next.js internationalization for Arabic, French, and English.\n\n## Configuration\n\n### next.config.js\n```javascript\nmodule.exports = {\n  i18n: {\n    locales: ['ar', 'fr', 'en'],\n    defaultLocale: 'en',\n    localeDetection: true,\n  },\n};\n```\n\n## Directory Structure\n```\nlib/i18n/\n├── locales/\n│   ├── ar.json\n│   ├── fr.json\n│   └── en.json\n├── useTranslation.ts\n└── config.ts\n```\n\n## Translation Keys Structure\n```json\n{\n  \"common\": {\n    \"search\": \"Search\",\n    \"favorites\": \"Favorites\",\n    \"reviews\": \"Reviews\"\n  },\n  \"home\": {\n    \"nearMe\": \"Near me\",\n    \"cityPicks\": \"Popular cities\"\n  },\n  \"place\": {\n    \"whatToOrder\": \"What to order\",\n    \"reviews\": \"Reviews\"\n  }\n}\n```\n\n## Hook Implementation\n```typescript\n// lib/i18n/useTranslation.ts\nexport function useTranslation() {\n  const locale = useLocale();\n  const messages = useMemo(() => loadMessages(locale), [locale]);\n  \n  const t = useCallback((key: string, params?: Record<string, string>) => {\n    const value = get(messages, key) || key;\n    return params ? interpolate(value, params) : value;\n  }, [messages]);\n  \n  return { t, locale };\n}\n```\n\n## Locale Switcher Component\nAllow users to switch language, persist preference.\n\n## Acceptance Criteria\n- [ ] All three locales configured\n- [ ] Translation hook working\n- [ ] Locale switcher in UI\n- [ ] User preference persisted","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:23:57.374531Z","created_by":"osekkat","updated_at":"2026-01-27T12:40:32.890215667Z","closed_at":"2026-01-27T12:40:32.890174516Z","close_reason":"Implemented complete i18n system: config with AR/FR/EN locales, full translation files for all UI strings, I18nProvider context with useTranslation hook, LocaleSwitcher component, RTL support for Arabic, and cookie-based persistence.","compaction_level":0,"original_size":0,"labels":["config","i18n","setup"],"dependencies":[{"issue_id":"foodapp-avek76","depends_on_id":"foodapp-549wnq","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-avek76","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-b49xc1","title":"Morocco Food Discovery App - Trust, Safety & Moderation","description":"## Overview\nThis epic implements the trust and safety layer: input validation, rate limiting, moderation workflows, RBAC for admins, and anti-abuse measures.\n\n## Input Validation Constraints\n| Field | Constraints |\n|-------|-------------|\n| Review text | 10-2000 chars, no URLs/emails |\n| Review rating | Integer 1-5 |\n| Dishes tried | 0-10 items, 1-40 chars each |\n| Price paid | Optional bucket (<30, 30-70, 70-150, 150+ MAD) |\n| List name | 1-100 chars |\n| Report reason | 10-500 chars required |\n| User name | 2-50 chars, alphanumeric + spaces |\n\n## Rate Limiting (Granular)\n| Action | Authenticated | Anonymous |\n|--------|---------------|-----------|\n| Search | 60/min | 20/min |\n| Place detail | 30/min | 30/min |\n| Review create | 5/hour | - |\n| Photo upload | 10/hour | - |\n| Report submit | 10/day | - |\n| Favorite toggle | 60/min | - |\n\n## UGC Photo Moderation (Enhanced)\nOriginal: photos just stored as IDs on reviews.\n\nNew ugcPhotos table with full pipeline:\n- EXIF stripping on upload (privacy)\n- Cloud Vision SafeSearch (NSFW detection)\n- Thumbnails + blurhash generation\n- Perceptual hash for spam/duplicate detection\n- Per-photo status: pending → approved/rejected\n- Moderation queue queryable by status\n\n## Reviewer Reputation\nTrust tiers: new → regular → trusted\n\nBased on:\n- Account age\n- Contribution quality (helpful votes)\n- No moderation actions\n\n**New/low-rep users**:\n- Lower rate limits\n- Reviews have 'cooldown' before public visibility\n\n## Anti-Spam Measures\n- Near-duplicate detection (hash/similarity on review text)\n- Flag reviews with repetitive text across places\n- One review per user per place (edit, don't duplicate)\n\n## RBAC for Admin/Moderation\nRoles: admin | moderator | editor\n\n**Critical**: All mutations check RBAC server-side (never client-side gating only).\n\n## Audit Logging\nAll privileged actions write immutable audit log:\n- actor, action, target, timestamp\n- Used for moderation disputes and compliance\n\n## Success Criteria\n- [ ] Input validation preventing malformed data\n- [ ] Rate limits enforced per action type\n- [ ] Photo moderation queue functional\n- [ ] Reputation tiers affecting visibility\n- [ ] Audit log capturing all privileged actions","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:23:15.277370Z","created_by":"osekkat","updated_at":"2026-01-27T17:58:35.283786260Z","closed_at":"2026-01-27T17:58:35.283742645Z","close_reason":"All child tasks completed: RBAC, rate limiting","compaction_level":0,"original_size":0,"labels":["moderation","p1","safety","security","trust"]}
{"id":"foodapp-b9sj7b","title":"Implement user profile page","description":"## Task\nBuild the user profile page showing user info, contributions, and settings.\n\n## Profile Sections\n\n### 1. Profile Header\n- Avatar (from OAuth or uploaded)\n- Display name\n- Member since date\n- Contribution stats (reviews, helpful votes)\n\n### 2. My Reviews Tab\n- List of user's reviews\n- Edit/delete actions\n- Sorted by recent\n\n### 3. My Lists Tab\n- Favorites count\n- Custom lists\n- Itineraries\n- Create new list button\n\n### 4. Saved Places Tab\n- Quick access to favorites\n- Filter by city\n- Personal notes visible\n\n### 5. Settings\n- Display name edit\n- Locale preference\n- Default city\n- Distance unit (km/mi)\n- Analytics opt-out\n- Sign out\n\n## URL Structure\n```\n/profile           # Current user's profile\n/profile/reviews   # My reviews\n/profile/lists     # My lists\n/profile/settings  # Settings\n/user/[userId]     # Public profile (future)\n```\n\n## Implementation\n```typescript\n// app/(main)/profile/page.tsx\nexport default async function ProfilePage() {\n  const user = await requireAuth();\n  const stats = await getUserStats(user._id);\n  \n  return (\n    <div>\n      <ProfileHeader user={user} stats={stats} />\n      <Tabs defaultValue='reviews'>\n        <TabsList>\n          <TabsTrigger value='reviews'>Reviews</TabsTrigger>\n          <TabsTrigger value='lists'>Lists</TabsTrigger>\n          <TabsTrigger value='saved'>Saved</TabsTrigger>\n        </TabsList>\n        <TabsContent value='reviews'><UserReviews /></TabsContent>\n        <TabsContent value='lists'><UserLists /></TabsContent>\n        <TabsContent value='saved'><SavedPlaces /></TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n```\n\n## Privacy\n- Only show public info on public profiles (future)\n- Settings always private\n- Respect analytics opt-out\n\n## Acceptance Criteria\n- [ ] Profile header with stats\n- [ ] All tabs working\n- [ ] Settings editable\n- [ ] Sign out working\n- [ ] Responsive design","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T19:24:39.486860Z","created_by":"osekkat","updated_at":"2026-01-27T12:26:10.434380894Z","closed_at":"2026-01-27T12:26:10.434344329Z","close_reason":"Implemented user profile page with: convex/profile.ts (queries/mutations), components/profile/ (ProfileHeader, ProfileReviews, ProfileLists, ProfileSettings), updated ProfileContent with tabs","compaction_level":0,"original_size":0,"labels":["profile","ui","user"],"dependencies":[{"issue_id":"foodapp-b9sj7b","depends_on_id":"foodapp-7yjl4v","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-b9sj7b","depends_on_id":"foodapp-83tb1i","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-b9sj7b","depends_on_id":"foodapp-jnmve2","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-bgdx9l","title":"Morocco Food Discovery App - Observability & Reliability","description":"## Overview\nThis epic implements comprehensive observability, SLOs, alerting, and reliability patterns to ensure the app is production-ready.\n\n## Performance Targets\n| Metric | Target |\n|--------|--------|\n| Search P95 (backend) | <100ms |\n| Search P95 (e2e, provider hit) | <800ms |\n| Search P95 (e2e, cache hit) | <300ms |\n| Place detail P95 | <800ms |\n| Map initial render | <2s |\n| Time to interactive | <3s |\n\n## Cost Metrics\n- Google Places API calls/hour by endpoint type\n- Cache hit rate (target: >70% after 30 days)\n- Cost per active user per day\n- Cost per user journey (autocomplete → selection → details)\n- Photo proxy bandwidth\n- FieldMask/SKU mix (Essentials vs Pro vs Enterprise)\n- Cost spikes by feature flag\n\n## Business Metrics\n- Search-to-detail CTR\n- Detail-to-favorite conversion\n- Reviews per active user per week\n- List creation rate\n- Share events\n\n## SLOs (Reliability Targets)\n- Search success rate: 99.5% over 7 days\n- Place page success rate: 99.5% over 7 days\n- Error budget policy: >50% burned → auto-tighten limits + disable expensive features\n\n## Alerting Thresholds\n| Metric | Threshold | Action |\n|--------|-----------|--------|\n| API error rate | >5% for 5min | Page on-call, enable degraded mode |\n| Search P95 | >2s for 10min | Warning |\n| Daily API cost | > | Alert + emergency throttling |\n| Cache hit rate | <50% for 1hr | Investigate |\n| Review spam flags | >10/hour | Alert moderation |\n\n## Synthetic Monitoring (Canaries)\nScheduled canary hitting:\n- Provider health (lightweight call)\n- Photo proxy endpoint\n- Key user flows (search + details)\n\nCanary failures → page on-call, optionally flip feature flags.\n\n## Scheduled Safety Jobs (Cron)\n- **Geo expiry purge**: Delete expired lat/lng rows\n- **ID-only cache purge**: Delete expired mapTileCache + searchResultCache\n- **Aggregates repair**: Recompute favoritesCount, communityRatingAvg/Count\n- **Budget watchdog**: Flip feature flags if threshold crossed\n- **Degraded mode manager**: Promote/demote based on health + error budget\n\n## Observability Stack\n- Sentry for errors (with provider content redaction)\n- Custom metrics dashboard\n- Real-time cost tracking\n\n## Success Criteria\n- [ ] All key metrics being captured\n- [ ] Alerts firing on threshold breaches\n- [ ] Canaries running and catching issues\n- [ ] Cron jobs maintaining data hygiene\n- [ ] SLO dashboards visible to team","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:22:26.309769Z","created_by":"osekkat","updated_at":"2026-01-27T17:58:58.202073635Z","closed_at":"2026-01-27T17:58:58.202031572Z","close_reason":"All child tasks completed: alerting system, metrics dashboard","compaction_level":0,"original_size":0,"labels":["monitoring","observability","p1","reliability","slos"]}
{"id":"foodapp-cmnis6","title":"Morocco Food Discovery App - Photo Proxy & Security Hardening","description":"## Overview\nThis epic implements the photo proxy with proper security controls, signed URLs to prevent hotlinking, and broader security hardening measures.\n\n## Photo Proxy Architecture\nSingle Next.js Route Handler: `/api/photos/{placeId}/{photoRef}`\n\n**Critical change from original plan**: Photo proxy now flows through ProviderGateway, not directly to Google. This ensures:\n- Budget enforcement\n- Circuit breaker protection\n- Consistent metrics/logging\n- Feature flag respect (photos disabled in Mode 1+)\n\n## Signed URLs (Hotlink Prevention)\nThe photo proxy is expensive and easy to abuse. Solution:\n\n```\n/api/photos/{placeId}/{photoRef}?size=medium&exp=...&sig=...\n```\n\nBenefits:\n- Third parties can't burn your budget via hotlinking\n- Predictable cache keys\n- Better incident response ('invalidate signatures' by rotating key)\n\n## Cache Headers\nExplicit and small TTL:\n```\nCache-Control: public, s-maxage=900, max-age=300, stale-while-revalidate=60\n```\n\n- CDN caches for 15 minutes\n- Browser caches for 5 minutes\n- Stale-while-revalidate for graceful refresh\n\n## Photo Proxy Features\n- Server-side caching (short TTL, policy-safe)\n- Image resizing (thumbnail, medium, full)\n- WebP/AVIF format conversion\n- API key never exposed to client\n- No persistence of image bytes\n\n## Security Hardening (Broader)\n\n### Content Security Policy\nStrict CSP suitable for Maps JS + your domains.\n\n### Bot Protection\nProgressive challenges for anonymous high-cost endpoints:\n- Search\n- Details\n- Photos\n\n### Key Security\n- Browser key: Maps JS API only, HTTP referrer restrictions\n- Server key: Places API only, Convex env + Next.js server env only\n- NEVER in client bundles\n\n### Error Reporting\nSentry with provider content redaction:\n- beforeSend filtering\n- Breadcrumb filtering\n- No provider response bodies in error reports\n\n### Service Worker Allowlist\n- ✅ OK: /guides/*, /lists/* (owned), static assets\n- ❌ Never: /place/* routes with provider fields, photo proxy responses\n\n## Success Criteria\n- [ ] Photo proxy using signed URLs in production\n- [ ] Hotlinking attempts rejected\n- [ ] CSP preventing XSS vectors\n- [ ] API keys properly isolated\n- [ ] No provider content in Sentry","status":"closed","priority":0,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:22:45.276661Z","created_by":"osekkat","updated_at":"2026-01-27T15:45:54.709805917Z","closed_at":"2026-01-27T15:45:54.709762462Z","close_reason":"Photo Proxy epic complete: photo proxy route handler implemented with full ProviderGateway integration, CSP/security headers implemented","compaction_level":0,"original_size":0,"labels":["hardening","p0","photo-proxy","security"],"dependencies":[{"issue_id":"foodapp-cmnis6","depends_on_id":"foodapp-dpikri","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-dmwjyn","title":"Implement transliteration for AR/FR/EN search","description":"## Task\nImplement transliteration to normalize Arabic/French/English search variants.\n\n## The Problem\nMorocco is multilingual. Users might search:\n- 'tagine' (English)\n- 'tajine' (French spelling)\n- 'طاجين' (Arabic)\n\nAll should match the same thing.\n\n## Common Mappings\n```typescript\nconst TRANSLITERATIONS = {\n  tagine: ['tajine', 'طاجين', 'طجين'],\n  couscous: ['كسكس', 'كسكسو'],\n  pastilla: ['bastilla', 'بسطيلة'],\n  harira: ['حريرة'],\n  msemen: ['مسمن'],\n  rfissa: ['رفيسة'],\n  // ... more Moroccan dishes\n};\n```\n\n## Implementation Strategy\n\n### At Index Time\nWhen content is created/updated, generate searchable text with all variants:\n```typescript\nfunction expandForSearch(text: string): string {\n  let expanded = text;\n  for (const [canonical, variants] of Object.entries(TRANSLITERATIONS)) {\n    if (text.toLowerCase().includes(canonical)) {\n      expanded += ' ' + variants.join(' ');\n    }\n  }\n  return expanded;\n}\n```\n\n### At Query Time\nNormalize user query to canonical form:\n```typescript\nfunction normalizeQuery(query: string): string {\n  let normalized = query.toLowerCase();\n  for (const [canonical, variants] of Object.entries(TRANSLITERATIONS)) {\n    for (const variant of variants) {\n      normalized = normalized.replace(variant, canonical);\n    }\n  }\n  return normalized;\n}\n```\n\n## Arabic-Specific Handling\n- Remove diacritics (tashkeel)\n- Normalize alef variants (أ إ آ → ا)\n- Handle ta marbuta (ة → ه or drop)\n\n## Library Options\n- lightweight custom mapping table (recommended for this use case)\n- Or: arabic-reshaper, unorm for Unicode normalization\n\n## Testing\n- Query 'tajine' → matches content with 'tagine'\n- Query 'طاجين' → matches English 'tagine'\n- Query 'tagine marrakech' → matches both terms\n\n## Acceptance Criteria\n- [ ] Mapping table covers common Moroccan dishes\n- [ ] Index-time expansion working\n- [ ] Query-time normalization working\n- [ ] Cross-script matching verified","notes":"Implementation complete by Claude (2026-01-27): lib/transliteration.ts fully implemented with MOROCCAN_FOOD_TRANSLITERATIONS mapping, Arabic normalization (normalizeArabic), index-time expansion (expandForSearch), query-time normalization (normalizeQuery/parseSearchQuery), and utility functions. 39 tests passing. Awaiting parent epic closure.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:28:19.763100Z","created_by":"osekkat","updated_at":"2026-01-27T13:53:21.785882110Z","closed_at":"2026-01-27T13:53:04.207605640Z","compaction_level":0,"original_size":0,"labels":["i18n","search","transliteration"],"dependencies":[{"issue_id":"foodapp-dmwjyn","depends_on_id":"foodapp-il4keg","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-dpikri","title":"Morocco Food Discovery App - Provider Gateway & Policy Engine","description":"## Overview\nThis epic implements the centralized Provider Gateway - the single enforcement surface for all external provider interactions. This is the most critical architectural component for policy compliance and cost control.\n\n## Why This Architecture\nThe plan identified a major gap: the original design had PhotoProxyRoute calling GooglePlaces directly, bypassing policy enforcement. This creates:\n- Budget/rate limit escape hatches\n- Inconsistent logging/observability\n- Degraded mode gaps (photos still expensive when search disabled)\n\n**Solution**: ALL provider access flows through ProviderGateway, including the photo proxy. This gives us:\n- One enforcement surface for budgets, circuit breaker, redaction, metrics\n- Consistent feature-flag behavior\n- Fewer special cases = fewer ToS violations\n\n## Key Components\n1. **ProviderGateway wrapper** - Central enforcement layer\n2. **Field mask registry** - Pre-approved field sets only, no ad-hoc masks\n3. **Budget guardrails** - Per-endpoint class limits (autocomplete/search/details/photos)\n4. **Circuit breaker** - Closed → Open → Half-Open state machine\n5. **Singleflight** - Request coalescing to prevent stampedes\n6. **Priority classes** - Load shedding order: details > search > autocomplete > photos\n\n## Policy Guardrails (Non-Negotiable)\n- Never log full provider responses\n- Analytics use placeKey only, never provider name/address\n- Client storage: IDs + owned content drafts only\n- Provider-backed Next.js routes must be no-store\n\n## Places API (New) Alignment\n- Health check uses proper format: `places.googleapis.com/v1/places/{placeId}`\n- Field mask via `X-Goog-FieldMask` header (mandatory, no defaults)\n- Localization defaults: `languageCode` from user locale, `regionCode: MA`\n\n## Success Criteria\n- [ ] Zero direct provider calls outside ProviderGateway\n- [ ] Budget exceeded → automatic feature degradation\n- [ ] Circuit breaker prevents cascade failures\n- [ ] Compliance tests pass (no provider content in persistence/logs)","status":"closed","priority":0,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:21:28.819013Z","created_by":"osekkat","updated_at":"2026-01-27T15:45:46.184634479Z","closed_at":"2026-01-27T15:45:46.184591475Z","close_reason":"All Provider Gateway tasks completed: ProviderGateway wrapper, circuit breaker, budget guardrails, singleflight","compaction_level":0,"original_size":0,"labels":["compliance","p0","policy","provider"],"dependencies":[{"issue_id":"foodapp-dpikri","depends_on_id":"foodapp-qpbwny","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-dzoupr","title":"Set up testing infrastructure with Vitest and Playwright","description":"## Task\nConfigure the testing stack: Vitest for unit/integration tests, Playwright for E2E, axe-core for accessibility.\n\n## Installation\n```bash\nnpm install -D vitest @vitest/coverage-v8 @vitest/ui\nnpm install -D playwright @playwright/test\nnpm install -D @axe-core/playwright\nnpx playwright install\nnpm install -D msw\n```\n\n## Vitest Configuration\n```typescript\n// vitest.config.ts\nimport { defineConfig } from 'vitest/config';\nimport react from '@vitejs/plugin-react';\nimport path from 'path';\n\nexport default defineConfig({\n  plugins: [react()],\n  test: {\n    environment: 'jsdom',\n    globals: true,\n    setupFiles: ['./tests/setup.ts'],\n    coverage: {\n      provider: 'v8',\n      reporter: ['text', 'json', 'html'],\n      exclude: ['node_modules/', 'tests/', '**/*.d.ts'],\n    },\n  },\n  resolve: {\n    alias: {\n      '@': path.resolve(__dirname, './'),\n    },\n  },\n});\n```\n\n## Playwright Configuration\n```typescript\n// playwright.config.ts\nimport { defineConfig, devices } from '@playwright/test';\n\nexport default defineConfig({\n  testDir: './tests/e2e',\n  fullyParallel: true,\n  forbidOnly: !!process.env.CI,\n  retries: process.env.CI ? 2 : 0,\n  workers: process.env.CI ? 1 : undefined,\n  reporter: 'html',\n  use: {\n    baseURL: 'http://localhost:3000',\n    trace: 'on-first-retry',\n  },\n  projects: [\n    { name: 'chromium', use: { ...devices['Desktop Chrome'] } },\n    { name: 'firefox', use: { ...devices['Desktop Firefox'] } },\n    { name: 'mobile-chrome', use: { ...devices['Pixel 5'] } },\n  ],\n  webServer: {\n    command: 'npm run dev',\n    url: 'http://localhost:3000',\n    reuseExistingServer: !process.env.CI,\n  },\n});\n```\n\n## MSW Setup for Mocking\n```typescript\n// tests/mocks/handlers.ts\nimport { rest } from 'msw';\n\nexport const handlers = [\n  rest.get('https://places.googleapis.com/v1/*', (req, res, ctx) => {\n    return res(ctx.json(mockPlaceResponse));\n  }),\n];\n```\n\n## Test Scripts\n```json\n// package.json\n{\n  \"scripts\": {\n    \"test\": \"vitest\",\n    \"test:ui\": \"vitest --ui\",\n    \"test:coverage\": \"vitest run --coverage\",\n    \"test:e2e\": \"playwright test\",\n    \"test:e2e:ui\": \"playwright test --ui\",\n    \"test:a11y\": \"playwright test tests/e2e/accessibility.spec.ts\"\n  }\n}\n```\n\n## Directory Structure\n```\ntests/\n├── unit/           # Vitest unit tests\n├── integration/    # Convex integration tests\n├── e2e/            # Playwright E2E tests\n├── fixtures/       # Google API response fixtures\n├── mocks/          # MSW handlers\n├── utils/          # Test helpers\n└── setup.ts        # Global test setup\n```\n\n## Acceptance Criteria\n- [ ] Vitest running unit tests\n- [ ] Playwright running E2E tests\n- [ ] MSW mocking Google API\n- [ ] Coverage reports generating\n- [ ] All configs committed","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T18:57:43.486998Z","created_by":"osekkat","updated_at":"2026-01-27T12:53:30.379505563Z","closed_at":"2026-01-27T12:53:30.379475588Z","close_reason":"done","compaction_level":0,"original_size":0,"labels":["infrastructure","setup","testing"],"dependencies":[{"issue_id":"foodapp-dzoupr","depends_on_id":"foodapp-5ytdb3","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-dzoupr","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-ep42ns","title":"Morocco Food Discovery App - Map & Geospatial Features","description":"## Overview\nThis epic implements the map-first discovery experience with sophisticated performance optimizations and cost controls for map interactions.\n\n## Key Challenge: Map Pan Stampedes\nMap interactions generate LOTS of provider calls:\n- Every pan triggers potential 'search this area'\n- Zooming changes visible places\n- Multiple concurrent users = amplified load\n\n## Solution: ID-Only Tile Cache (Policy-Safe)\nThe mapTileCache table stores:\n- `{tileKey -> [placeKey...]}` with TTL\n- Geohash/S2 tiles with zoom-derived granularity\n- Chunked documents to avoid oversized rows\n\n**Why this is policy-safe**: We store ONLY IDs, never provider content. Provider content is fetched ephemerally and kept in-memory only.\n\n## Performance Patterns\n\n### Client-Side\n- Debounce bounds changes (300ms)\n- Throttle marker updates (max 1/100ms during pan)\n- Maintain `seenTiles` set - only request newly-visible tiles\n- Marker recycling (reuse instead of create/destroy)\n\n### Server-Side\n- Viewport buffer + strict post-filter\n- Clustering when >50 markers visible\n- Singleflight coalescing for concurrent tile requests\n- Separate rate limit for map-pan vs text search\n\n## ID-Only Tile Cache Schema\n```typescript\nmapTileCache: defineTable({\n  tileKey: v.string(),           // e.g. 's2:12:89ab...'\n  zoom: v.number(),\n  chunk: v.number(),             // 0..N\n  provider: v.string(),          // 'google'\n  placeKeys: v.array(v.string()),// ID-only\n  expiresAt: v.number(),\n  createdAt: v.number(),\n})\n```\n\n## Stampede Protection\n- Cap concurrent provider calls (max 25 in-flight per region)\n- Under load: serve cached tile IDs + 'results may be incomplete' hint\n- Priority class: map pans are lower than explicit search/details\n\n## Success Criteria\n- [ ] Map tile cache reducing provider calls by >70%\n- [ ] P95 pan-to-render <500ms with warm cache\n- [ ] No stampedes even with concurrent users\n- [ ] Graceful degradation to cache-only in Mode 2+","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:22:03.363804Z","created_by":"osekkat","updated_at":"2026-01-27T17:05:33.735536009Z","closed_at":"2026-01-27T17:05:33.735492323Z","close_reason":"All child tasks completed: Google Maps integration (foodapp-6e5efz), Search this area (foodapp-okcm4c), and ID-only map tile cache (foodapp-87mxxx) are all implemented and closed.","compaction_level":0,"original_size":0,"labels":["geospatial","map","p1","performance"],"dependencies":[{"issue_id":"foodapp-ep42ns","depends_on_id":"foodapp-qpbwny","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-foljg0","title":"Implement editorial guides","description":"## Task\nBuild the editorial guides system - curated lists like 'Best tagine in Marrakech'.\n\n## What Guides Contain\n- title: e.g., 'Best Tagine in Marrakech'\n- slug: URL-friendly (/guides/best-tagine-marrakech)\n- description: Editorial intro\n- coverImageUrl: Featured image (owned)\n- placeKeys: Array of places in the guide\n- city, categorySlug: For filtering\n- locale: ar/fr/en\n\n## Schema\n```typescript\nguides: defineTable({\n  title: v.string(),\n  slug: v.string(),\n  description: v.string(),\n  coverImageUrl: v.string(),\n  city: v.optional(v.string()),\n  categorySlug: v.optional(v.string()),\n  placeKeys: v.array(v.string()),\n  authorId: v.optional(v.id('users')),\n  publishedAt: v.optional(v.number()),\n  featured: v.boolean(),\n  sortOrder: v.number(),\n  locale: v.string(),\n})\n  .index('by_slug', ['slug'])\n  .index('by_city', ['city'])\n  .index('by_featured', ['featured', 'sortOrder']),\n```\n\n## Guide Page\n```\n/guides/[slug]\n    ↓\nFetch guide by slug\n    ↓\nFor each placeKey in guide:\n  - If 'c:' prefix: show curated card only\n  - If 'g:' prefix: try provider details, fall back to owned data\n    ↓\nRender list with editorial context\n```\n\n## SEO Considerations\nGuides are great for SEO because:\n- Owned content (can be indexed)\n- Keyword-rich titles\n- Structured data (ItemList schema)\n\n```typescript\n// app/guides/[slug]/page.tsx\nexport async function generateMetadata({ params }) {\n  const guide = await getGuide(params.slug);\n  return {\n    title: guide.title,\n    description: guide.description,\n    openGraph: {\n      images: [guide.coverImageUrl],\n    },\n  };\n}\n```\n\n## Featured on Home\n```typescript\nexport const getFeaturedGuides = query({\n  args: { city: v.optional(v.string()), locale: v.string() },\n  handler: async (ctx, { city, locale }) => {\n    let query = ctx.db\n      .query('guides')\n      .withIndex('by_featured', (q) => q.eq('featured', true));\n    \n    const guides = await query.collect();\n    \n    return guides\n      .filter(g => g.locale === locale)\n      .filter(g => \\!city || g.city === city)\n      .sort((a, b) => a.sortOrder - b.sortOrder)\n      .slice(0, 6);\n  },\n});\n```\n\n## Admin Interface\n- Create/edit guides\n- Reorder places in guide\n- Set featured status\n- Preview before publish\n\n## Acceptance Criteria\n- [ ] Guide CRUD working\n- [ ] Guide page rendering place list\n- [ ] SEO metadata generating\n- [ ] Featured guides on home page\n- [ ] Works in degraded mode (owned content)","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:33:49.901978Z","created_by":"osekkat","updated_at":"2026-01-27T17:57:13.995288235Z","closed_at":"2026-01-27T17:57:13.995245281Z","close_reason":"Verified implementation complete: guides CRUD, page rendering with place list, SEO metadata, featured guides query. All acceptance criteria met.","compaction_level":0,"original_size":0,"labels":["editorial","guides","seo"],"dependencies":[{"issue_id":"foodapp-foljg0","depends_on_id":"foodapp-2ym9m1","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-foljg0","depends_on_id":"foodapp-popupy","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-h77q26","title":"Implement taste tags and placeDishes aggregation","description":"## Task\nBuild community taste tags voting and the placeDishes aggregation for 'What to order' feature.\n\n## Taste Tags System\nCommunity can vote on tags for places:\n- tagine, couscous, seafood, coffee, pastries, etc.\n- Up/down voting per tag per place\n- Anonymous allowed (with rate limits)\n\n### placeTags Schema\n```typescript\nplaceTags: defineTable({\n  placeKey: v.string(),\n  tag: v.string(),         // normalized key\n  votesUp: v.number(),\n  votesDown: v.number(),\n  updatedAt: v.number(),\n}).index('by_place', ['placeKey']),\n```\n\n### Voting Mutation\n```typescript\nexport const voteTag = mutation({\n  args: {\n    placeKey: v.string(),\n    tag: v.string(),\n    vote: v.union(v.literal('up'), v.literal('down')),\n  },\n  handler: async (ctx, { placeKey, tag, vote }) => {\n    // Rate limit check\n    await checkRateLimit(ctx, 'tag_vote');\n    \n    const existing = await ctx.db\n      .query('placeTags')\n      .withIndex('by_place', (q) => q.eq('placeKey', placeKey))\n      .filter((q) => q.eq(q.field('tag'), tag))\n      .unique();\n    \n    if (existing) {\n      const update = vote === 'up'\n        ? { votesUp: existing.votesUp + 1 }\n        : { votesDown: existing.votesDown + 1 };\n      await ctx.db.patch(existing._id, { ...update, updatedAt: Date.now() });\n    } else {\n      await ctx.db.insert('placeTags', {\n        placeKey,\n        tag: normalizeTag(tag),\n        votesUp: vote === 'up' ? 1 : 0,\n        votesDown: vote === 'down' ? 1 : 0,\n        updatedAt: Date.now(),\n      });\n    }\n  },\n});\n```\n\n## placeDishes Aggregation\nTracks which dishes are mentioned for each place.\n\nSources:\n1. Review `dishesTried` fields\n2. Curated card `mustTry` lists\n\n### Schema\n```typescript\nplaceDishes: defineTable({\n  placeKey: v.string(),\n  dish: v.string(),           // normalized, e.g. 'tagine'\n  mentionsCount: v.number(),\n  lastMentionedAt: v.number(),\n  updatedAt: v.number(),\n})\n  .index('by_place', ['placeKey'])\n  .index('by_dish', ['dish']),\n```\n\n### Aggregation Trigger\nWhen review is created/updated:\n```typescript\nasync function updateDishMentions(ctx, placeKey, dishes) {\n  for (const dish of dishes) {\n    const normalized = normalizeDish(dish);\n    const existing = await findPlaceDish(ctx, placeKey, normalized);\n    \n    if (existing) {\n      await ctx.db.patch(existing._id, {\n        mentionsCount: existing.mentionsCount + 1,\n        lastMentionedAt: Date.now(),\n        updatedAt: Date.now(),\n      });\n    } else {\n      await ctx.db.insert('placeDishes', {\n        placeKey,\n        dish: normalized,\n        mentionsCount: 1,\n        lastMentionedAt: Date.now(),\n        updatedAt: Date.now(),\n      });\n    }\n  }\n}\n```\n\n## 'What to Order' Query\n```typescript\nexport const getTopDishes = query({\n  args: { placeKey: v.string() },\n  handler: async (ctx, { placeKey }) => {\n    const dishes = await ctx.db\n      .query('placeDishes')\n      .withIndex('by_place', (q) => q.eq('placeKey', placeKey))\n      .collect();\n    \n    return dishes\n      .sort((a, b) => b.mentionsCount - a.mentionsCount)\n      .slice(0, 5);\n  },\n});\n```\n\n## Acceptance Criteria\n- [ ] Tag voting working\n- [ ] Vote counts displaying\n- [ ] Dish mentions aggregating from reviews\n- [ ] 'What to order' showing top dishes","notes":"Implementation complete by RainyPrairie (2026-01-27): Created convex/tags.ts with voteTag mutation, getPlaceTags/getSuggestedTags queries, updateDishMentions internal mutation, getTopDishes/getPopularDishes/searchDishes queries. Integrated dish aggregation into reviews.ts. All 143 tests passing.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:32:22.168302Z","created_by":"osekkat","updated_at":"2026-01-27T13:56:59.032348091Z","closed_at":"2026-01-27T13:56:59.032261873Z","compaction_level":0,"original_size":0,"labels":["dishes","tags","ugc"],"dependencies":[{"issue_id":"foodapp-h77q26","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-h77q26","depends_on_id":"foodapp-t54nup","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-h77q26","depends_on_id":"foodapp-tpsmbw","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-hktdvu","title":"Initialize Next.js 16 project with App Router","description":"## Task\nCreate the Next.js project with proper configuration for the Morocco Food Discovery App.\n\n## Commands\n```bash\nnpx create-next-app@latest morocco-eats --typescript --tailwind --eslint --app\n```\n\n## Configuration Requirements\n- TypeScript strict mode enabled\n- Tailwind CSS with custom theme (Moroccan color palette)\n- ESLint with recommended rules\n- App Router (not Pages Router)\n\n## Why App Router\n- Server Components by default (better performance)\n- Nested layouts for consistent UI\n- Better streaming support\n- Native loading/error states\n\n## Key Files to Configure\n- next.config.js: i18n, image domains, env vars\n- tailwind.config.js: RTL support, custom colors\n- tsconfig.json: strict mode, path aliases\n\n## Acceptance Criteria\n- [ ] Project runs with `npm run dev`\n- [ ] TypeScript compiling without errors\n- [ ] Tailwind classes working\n- [ ] ESLint passing","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:23:31.747370Z","created_by":"osekkat","updated_at":"2026-01-27T10:10:45.822720172Z","closed_at":"2026-01-27T10:10:45.822677819Z","close_reason":"Already scaffolded in repo (Next 16 App Router, TS strict, Tailwind v4, ESLint config present).","compaction_level":0,"original_size":0,"labels":["nextjs","setup"],"dependencies":[{"issue_id":"foodapp-hktdvu","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-il4keg","title":"Morocco Food Discovery App - Search Architecture","description":"## Overview\nThis epic implements the two-track search architecture that cleanly separates provider discovery from owned content enrichment. This resolves a critical inconsistency in the original plan.\n\n## The Problem We're Solving\nThe original plan stated: 'Convex search index for cached places + Google fallback'\n\nBut policy says: DON'T persist provider place content (name/address/etc).\n\n**Contradiction**: You can't build a text search index over places you don't have text for.\n\n## The Solution: Two-Track Search\n\n### Track 1: Provider Discovery (Places)\n- Google Places (New) Text Search / Nearby Search\n- Returns ephemeral provider content for rendering\n- Returns place IDs for joining with owned data\n- Results cached as **ID-only** in searchResultCache (policy-safe)\n\n### Track 2: Owned Search (Food Intent)\n- Convex search indexes over owned content only:\n  - Dish mentions from `dishesTried` + editorial `mustTry`\n  - Curated place cards (title, summary, tags)\n  - Guides and lists\n  - Review text\n  - Taste tags\n\n## Cost Optimization Patterns\n1. **Session tokens** - Group autocomplete → selection → details into one billing session\n2. **Debounced input** - Don't fire on every keystroke\n3. **Request coalescing** - Dedupe identical in-flight requests\n4. **ID-only search cache** - Avoid repeat searches for same query\n5. **Strict field masks** - Only request fields actually displayed\n\n## Transliteration Support\nMorocco is AR/FR/EN heavy. Need to normalize variants:\n- tagine ↔ tajine ↔ طاجين\n- couscous ↔ كسكس\n\n## Popular Searches Privacy\nAdded k-anonymity threshold (≥20 unique users) + email/phone/URL filtering to prevent accidental PII exposure in trending queries.\n\n## Success Criteria\n- [ ] Clear separation: provider search vs owned search\n- [ ] ID-only search cache reducing repeat provider calls\n- [ ] Transliteration working across AR/FR/EN\n- [ ] Popular searches privacy compliant","status":"closed","priority":0,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:21:45.444459Z","created_by":"osekkat","updated_at":"2026-01-27T17:30:35.120445588Z","closed_at":"2026-01-27T17:30:35.120351957Z","compaction_level":0,"original_size":0,"labels":["cost-control","discovery","p0","search"],"dependencies":[{"issue_id":"foodapp-il4keg","depends_on_id":"foodapp-dpikri","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-inak6c","title":"Implement provider search with session tokens","description":"## Task\nImplement Google Places (New) search integration using session tokens for cost optimization.\n\n## Session Token Flow\n```\nUser starts typing\n    ↓\nCreate session token\n    ↓\nAutocomplete calls (all use same token)\n    ↓\nUser selects result\n    ↓\nPlace Details call (same token)\n    ↓\nSession complete, token discarded\n```\n\n## Why Session Tokens\nGoogle charges differently:\n- Autocomplete without details: per-request pricing\n- Autocomplete + details with token: bundled pricing\n\nUsing tokens can reduce costs significantly.\n\n## Implementation\n```typescript\n// lib/searchSession.ts\nclass SearchSession {\n  private token: string;\n  private createdAt: number;\n  private abortController: AbortController;\n  \n  constructor() {\n    this.token = crypto.randomUUID();\n    this.createdAt = Date.now();\n    this.abortController = new AbortController();\n  }\n  \n  async autocomplete(query: string): Promise<Prediction[]> {\n    // Cancel previous in-flight request\n    this.abortController.abort();\n    this.abortController = new AbortController();\n    \n    return providerGateway.autocomplete({\n      input: query,\n      sessionToken: this.token,\n      signal: this.abortController.signal,\n    });\n  }\n  \n  async selectPlace(placeId: string): Promise<PlaceDetails> {\n    const details = await providerGateway.placeDetails({\n      placeId,\n      sessionToken: this.token,\n    });\n    \n    // Session complete - token is consumed\n    this.invalidate();\n    return details;\n  }\n}\n```\n\n## Autocomplete Request (Places API New)\n```typescript\nPOST https://places.googleapis.com/v1/places:autocomplete\n{\n  input: 'tagine mar',\n  sessionToken: '...',\n  locationBias: { circle: { center: {...}, radius: 50000 } },\n  includedPrimaryTypes: ['restaurant', 'cafe', 'food'],\n}\n```\n\n## Debouncing\n- 300ms debounce on keystroke\n- Cancel previous request on new keystroke\n- Don't send if query < 2 chars\n\n## Acceptance Criteria\n- [ ] Session tokens grouping autocomplete + details\n- [ ] Debouncing preventing excessive calls\n- [ ] AbortController canceling stale requests\n- [ ] Metrics showing session token usage","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:27:36.661503Z","created_by":"osekkat","updated_at":"2026-01-27T10:27:34.826845272Z","closed_at":"2026-01-27T10:27:34.826812643Z","close_reason":"Implemented provider search with session tokens: 1) Added AUTOCOMPLETE field set to registry, 2) Added autocomplete endpoint support to providerGateway, 3) Created SearchSession class (lib/searchSession.ts) for session token lifecycle management, 4) Created useSearch hook (hooks/useSearch.ts) with debouncing and abort controller for request cancellation.","compaction_level":0,"original_size":0,"labels":["autocomplete","cost-control","search"],"dependencies":[{"issue_id":"foodapp-inak6c","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-inak6c","depends_on_id":"foodapp-il4keg","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-ixignq","title":"Implement Dish Explorer feature","description":"## Task\nBuild the Dish Explorer - browse by dish + city to find top places for specific foods.\n\n## Why This Differentiates\nGoogle can tell you 'restaurants near me'. We can tell you 'where to get the best tagine in Gueliz' - because we have dish-level data from UGC.\n\n## UI Flow\n```\nHome page → Dish quick-pick (e.g., 'Tagine')\n    ↓\nDish Explorer page (/explore/dishes/tagine)\n    ↓\nFilter by city (optional)\n    ↓\nList of places ranked by dish-specific signals\n```\n\n## Ranking Algorithm\nUses ONLY owned signals:\n```typescript\nfunction calculateDishScore(place, dish) {\n  const dishMentions = place.placeDishes[dish]?.mentionsCount || 0;\n  const favorites = place.favoritesCount;\n  const recentReviews = countRecentReviews(place, 30); // last 30 days\n  \n  return (\n    (dishMentions * 3) +      // Dish mentions weighted highest\n    (favorites * 1) +\n    (recentReviews * 2)\n  );\n}\n```\n\n## Query\n```typescript\nexport const exploreDish = query({\n  args: {\n    dish: v.string(),\n    city: v.optional(v.string()),\n  },\n  handler: async (ctx, { dish, city }) => {\n    // Get all places with this dish mentioned\n    const dishMentions = await ctx.db\n      .query('placeDishes')\n      .withIndex('by_dish', (q) => q.eq('dish', normalizedDish(dish)))\n      .collect();\n    \n    const placeKeys = dishMentions.map(d => d.placeKey);\n    \n    // Get place details + filter by city\n    const places = await Promise.all(\n      placeKeys.map(pk => getPlaceWithScore(ctx, pk, dish))\n    );\n    \n    const filtered = city\n      ? places.filter(p => p.city === city)\n      : places;\n    \n    return filtered\n      .sort((a, b) => b.dishScore - a.dishScore)\n      .slice(0, 20);\n  },\n});\n```\n\n## Home Page Dish Quick-Picks\n```typescript\nconst DISH_QUICK_PICKS = [\n  { dish: 'tagine', label: 'Tagine', labelAr: 'طاجين' },\n  { dish: 'couscous', label: 'Couscous', labelAr: 'كسكس' },\n  { dish: 'pastilla', label: 'Pastilla', labelAr: 'بسطيلة' },\n  { dish: 'seafood', label: 'Seafood', labelAr: 'مأكولات بحرية' },\n  { dish: 'coffee', label: 'Coffee', labelAr: 'قهوة' },\n  { dish: 'pastries', label: 'Pastries', labelAr: 'حلويات' },\n];\n```\n\n## Degraded Mode Friendly\nDish Explorer works in Mode 2+ because it uses only owned data:\n- placeDishes (aggregated from reviews)\n- favorites count\n- curated cards with mustTry\n\n## Acceptance Criteria\n- [ ] Dish explorer page working\n- [ ] Ranking by owned signals\n- [ ] City filtering working\n- [ ] Home page quick-picks linking correctly\n- [ ] Works in degraded mode","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:33:34.812868Z","created_by":"osekkat","updated_at":"2026-01-27T16:01:08.626471708Z","closed_at":"2026-01-27T16:01:08.626439972Z","close_reason":"Completed: Implemented Dish Explorer feature. Added exploreDish query (convex/tags.ts) with owned-signals ranking (dish mentions x3, recent reviews x2, favorites x1). Created /explore/dishes/[dish] page component with loading states, place cards, and proper routing. Updated DishQuickPicks to link to explorer pages. Also added getDishQuickPicks query for localized dish labels.","compaction_level":0,"original_size":0,"labels":["discovery","dishes","feature"],"dependencies":[{"issue_id":"foodapp-ixignq","depends_on_id":"foodapp-2ym9m1","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-ixignq","depends_on_id":"foodapp-h77q26","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-ixignq","depends_on_id":"foodapp-popupy","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-jnmve2","title":"Implement lists with favorites, custom, and itinerary types","description":"## Task\nBuild the user lists system supporting favorites, custom collections, and itineraries.\n\n## List Types\n\n### Favorites (Default)\n- Auto-created for each user\n- Quick save target\n- Simple ordered list\n\n### Custom Lists\n- User-created collections\n- Name + description\n- Can be private or public\n\n### Itineraries\n- Ordered food crawl\n- Time slots (breakfast/lunch/dinner)\n- Per-stop notes\n- Shareable with collaborators\n\n## Schema\n```typescript\nlists: defineTable({\n  userId: v.id('users'),\n  name: v.string(),\n  description: v.optional(v.string()),\n  coverPhotoReference: v.optional(v.string()),\n  type: v.string(), // 'favorites' | 'custom' | 'itinerary'\n  visibility: v.string(), // 'private' | 'public'\n  slug: v.optional(v.string()),\n  itemCount: v.number(),\n  createdAt: v.number(),\n  updatedAt: v.optional(v.number()),\n})\n\nlistItems: defineTable({\n  listId: v.id('lists'),\n  placeKey: v.string(),\n  sortOrder: v.number(),\n  timeSlot: v.optional(v.string()),\n  itemNote: v.optional(v.string()),\n  createdAt: v.number(),\n})\n```\n\n## List CRUD\n```typescript\nexport const createList = mutation({\n  args: {\n    name: v.string(),\n    type: v.string(),\n    visibility: v.string(),\n    description: v.optional(v.string()),\n  },\n  handler: async (ctx, args) => {\n    const userId = await requireAuth(ctx);\n    \n    const slug = args.visibility === 'public'\n      ? generateSlug(args.name)\n      : undefined;\n    \n    return ctx.db.insert('lists', {\n      userId,\n      ...args,\n      slug,\n      itemCount: 0,\n      createdAt: Date.now(),\n    });\n  },\n});\n```\n\n## Add/Remove Items\n```typescript\nexport const addToList = mutation({\n  args: {\n    listId: v.id('lists'),\n    placeKey: v.string(),\n    timeSlot: v.optional(v.string()),\n    itemNote: v.optional(v.string()),\n  },\n  handler: async (ctx, args) => {\n    await requireListAccess(ctx, args.listId, 'edit');\n    \n    // Check if already in list\n    const existing = await ctx.db\n      .query('listItems')\n      .withIndex('by_list_place', (q) =>\n        q.eq('listId', args.listId).eq('placeKey', args.placeKey)\n      )\n      .unique();\n    \n    if (existing) {\n      throw new Error('Already in list');\n    }\n    \n    // Get next sort order\n    const items = await ctx.db\n      .query('listItems')\n      .withIndex('by_list', (q) => q.eq('listId', args.listId))\n      .collect();\n    const sortOrder = items.length;\n    \n    await ctx.db.insert('listItems', {\n      ...args,\n      sortOrder,\n      createdAt: Date.now(),\n    });\n    \n    // Update item count\n    await ctx.db.patch(args.listId, {\n      itemCount: items.length + 1,\n      updatedAt: Date.now(),\n    });\n  },\n});\n```\n\n## Reordering (Drag and Drop)\n```typescript\nexport const reorderListItems = mutation({\n  args: {\n    listId: v.id('lists'),\n    itemIds: v.array(v.id('listItems')),\n  },\n  handler: async (ctx, { listId, itemIds }) => {\n    await requireListAccess(ctx, listId, 'edit');\n    \n    for (let i = 0; i < itemIds.length; i++) {\n      await ctx.db.patch(itemIds[i], { sortOrder: i });\n    }\n  },\n});\n```\n\n## Acceptance Criteria\n- [ ] Three list types working\n- [ ] Add/remove items\n- [ ] Drag-and-drop reordering\n- [ ] Time slots for itineraries\n- [ ] Item notes for itineraries","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:35:12.579697Z","created_by":"osekkat","updated_at":"2026-01-27T11:36:49.133539892Z","closed_at":"2026-01-27T11:36:49.133500152Z","close_reason":"Completed: Full lists.ts implementation with createList, getUserLists, getList, updateList, deleteList, addToList, removeFromList, getListItems, reorderListItems, updateListItem, toggleFavorite, isInFavorites. Supports favorites, custom, and itinerary types with time slots and notes.","compaction_level":0,"original_size":0,"labels":["core","lists","user-features"],"dependencies":[{"issue_id":"foodapp-jnmve2","depends_on_id":"foodapp-7yjl4v","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-jnmve2","depends_on_id":"foodapp-83tb1i","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-jnmve2","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-jwdyq1","title":"Implement collaborative lists with real-time sync","description":"## Task\nAdd collaboration features to lists - roles, invites, and real-time sync using Convex.\n\n## Why Collaboration\n- High retention (people plan together)\n- Natural growth (shares lead to signups)\n- All owned data (policy-safe)\n- Convex makes real-time 'free'\n\n## Roles\n- **Owner**: Full control, can delete list, manage collaborators\n- **Editor**: Can add/remove/reorder items, edit notes\n- **Viewer**: Read-only access\n\n## Schema Additions\n```typescript\nlistCollaborators: defineTable({\n  listId: v.id('lists'),\n  userId: v.id('users'),\n  role: v.string(), // 'owner' | 'editor' | 'viewer'\n  createdAt: v.number(),\n})\n  .index('by_list', ['listId'])\n  .index('by_user', ['userId'])\n  .index('by_list_user', ['listId', 'userId']),\n\nlistInvites: defineTable({\n  listId: v.id('lists'),\n  inviteCode: v.string(),\n  role: v.string(), // 'editor' | 'viewer'\n  createdByUserId: v.id('users'),\n  createdAt: v.number(),\n  expiresAt: v.number(),\n})\n  .index('by_code', ['inviteCode'])\n  .index('by_list', ['listId']),\n```\n\n## Creating Invites\n```typescript\nexport const createInvite = mutation({\n  args: {\n    listId: v.id('lists'),\n    role: v.union(v.literal('editor'), v.literal('viewer')),\n    expiresInDays: v.optional(v.number()),\n  },\n  handler: async (ctx, { listId, role, expiresInDays = 7 }) => {\n    await requireListAccess(ctx, listId, 'owner');\n    const userId = await requireAuth(ctx);\n    \n    const inviteCode = generateInviteCode();\n    const expiresAt = Date.now() + (expiresInDays * 24 * 60 * 60 * 1000);\n    \n    await ctx.db.insert('listInvites', {\n      listId,\n      inviteCode,\n      role,\n      createdByUserId: userId,\n      createdAt: Date.now(),\n      expiresAt,\n    });\n    \n    return { inviteCode, expiresAt };\n  },\n});\n```\n\n## Accepting Invites\n```typescript\nexport const acceptInvite = mutation({\n  args: { inviteCode: v.string() },\n  handler: async (ctx, { inviteCode }) => {\n    const userId = await requireAuth(ctx);\n    \n    const invite = await ctx.db\n      .query('listInvites')\n      .withIndex('by_code', (q) => q.eq('inviteCode', inviteCode))\n      .unique();\n    \n    if (!invite || invite.expiresAt < Date.now()) {\n      throw new Error('Invalid or expired invite');\n    }\n    \n    // Check if already a collaborator\n    const existing = await ctx.db\n      .query('listCollaborators')\n      .withIndex('by_list_user', (q) =>\n        q.eq('listId', invite.listId).eq('userId', userId)\n      )\n      .unique();\n    \n    if (existing) {\n      throw new Error('Already a collaborator');\n    }\n    \n    await ctx.db.insert('listCollaborators', {\n      listId: invite.listId,\n      userId,\n      role: invite.role,\n      createdAt: Date.now(),\n    });\n    \n    return { listId: invite.listId };\n  },\n});\n```\n\n## Real-Time Sync\nConvex subscriptions automatically update all connected clients:\n```typescript\n// In React component\nconst listItems = useQuery(api.lists.getItems, { listId });\n// Auto-updates when any collaborator makes changes\n```\n\n## Access Control Helper\n```typescript\nasync function requireListAccess(\n  ctx: MutationCtx,\n  listId: Id<'lists'>,\n  requiredRole: 'owner' | 'edit' | 'view'\n) {\n  const userId = await requireAuth(ctx);\n  const list = await ctx.db.get(listId);\n  \n  if (!list) throw new Error('List not found');\n  \n  // Owner always has access\n  if (list.userId === userId) return;\n  \n  const collab = await ctx.db\n    .query('listCollaborators')\n    .withIndex('by_list_user', (q) =>\n      q.eq('listId', listId).eq('userId', userId)\n    )\n    .unique();\n  \n  if (!collab) throw new Error('No access');\n  \n  if (requiredRole === 'owner' && collab.role !== 'owner') {\n    throw new Error('Owner access required');\n  }\n  if (requiredRole === 'edit' && collab.role === 'viewer') {\n    throw new Error('Edit access required');\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] Invite creation and sharing\n- [ ] Invite acceptance flow\n- [ ] Role-based access control\n- [ ] Real-time sync working\n- [ ] Collaborator management UI","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:35:32.145568Z","created_by":"osekkat","updated_at":"2026-01-27T12:33:28.588177258Z","closed_at":"2026-01-27T12:33:28.588135796Z","close_reason":"Implemented collaborative lists: convex/listCollaboration.ts (invite creation/acceptance, role-based access, collaborator management), updated convex/lists.ts with collaboration support","compaction_level":0,"original_size":0,"labels":["collaboration","lists","realtime"],"dependencies":[{"issue_id":"foodapp-jwdyq1","depends_on_id":"foodapp-7yjl4v","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-jwdyq1","depends_on_id":"foodapp-jnmve2","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-kri2kv","title":"Implement core Convex database schema","description":"## Task\nImplement the complete Convex database schema as defined in the plan, including all new tables from the revisions.\n\n## Schema Overview\nThe schema is policy-first: provider identifiers allowed, provider content forbidden.\n\n## Core Tables\n\n### User & Auth\n- users - Basic profile + contribution stats\n- userReputation - Trust tier tracking\n- userRoles - RBAC for admin/moderation\n- userPreferences - Settings\n\n### Places (Policy-Safe Anchors)\n- places - placeKey + provider refs + geo (with expiry) + aggregates\n- curatedPlaces - Owned editorial cards\n- placeTags - Community taste tags\n- placeDishes - Dish mentions (NEW from revisions)\n- userPlaceNotes - Personal notes/nicknames\n\n### ID-Only Caches (NEW from revisions)\n- searchResultCache - `{cacheKey -> [placeKey...]}` with TTL\n- mapTileCache - `{tileKey -> [placeKey...]}` with TTL, chunked\n\n### UGC\n- reviews - One per user per place\n- reviewEdits - Edit history for audit\n- reviewHelpful - Helpful votes\n- ugcPhotos - NEW: Per-photo moderation status\n- reviewReports - Moderation flags\n\n### Lists & Collaboration\n- lists - Favorites/custom/itinerary\n- listItems - Items with ordering and notes\n- listCollaborators - NEW: Roles for collaboration\n- listInvites - NEW: Invite codes\n\n### Editorial\n- guides - Curated guides\n- categories - Place categories\n- cities - City metadata\n\n### System\n- rateLimits - Rate limiting state\n- systemHealth - Provider health tracking\n- featureFlags - Runtime flags\n- auditLogs - Privileged action audit\n\n## Key Indexes\nAll tables need appropriate indexes for:\n- Primary lookups (by_placeKey, by_user)\n- Expiry queries (by_expiry, by_geo_expiry)\n- Moderation (by_status_recent)\n\n## Acceptance Criteria\n- [ ] All tables defined in schema.ts\n- [ ] Indexes created for query patterns\n- [ ] Schema deploys without errors\n- [ ] Types generating correctly","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:24:50.501325Z","created_by":"osekkat","updated_at":"2026-01-27T10:11:56.139030708Z","closed_at":"2026-01-27T10:11:56.138991388Z","close_reason":"Schema already implemented in convex/schema.ts with required tables + indexes; Convex _generated exists.","compaction_level":0,"original_size":0,"labels":["convex","database","schema"],"dependencies":[{"issue_id":"foodapp-kri2kv","depends_on_id":"foodapp-oec6mt","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-kri2kv","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-l0vnyq","title":"Implement Service Mode state machine","description":"## Task\nBuild the multi-level Service Mode system that progressively degrades features based on triggers.\n\n## Service Mode Levels\n\n| Mode | Trigger | Description |\n|------|---------|-------------|\n| 0 (Normal) | healthy + budget ok | Full functionality |\n| 1 (Cost-Saver) | cost spike OR latency spike | Tighter limits, photos disabled |\n| 2 (Provider-Limited) | provider errors OR breaker open | Owned search only, cache-only map |\n| 3 (Offline/Owned) | offline OR emergency | Only owned data accessible |\n\n## State Machine\n```typescript\n// convex/serviceMode.ts\ninterface ServiceModeState {\n  currentMode: 0 | 1 | 2 | 3;\n  reason: string;\n  enteredAt: number;\n  triggers: {\n    providerHealth: boolean;\n    budgetOk: boolean;\n    latencyOk: boolean;\n    circuitBreakerClosed: boolean;\n  };\n}\n\nexport const evaluateServiceMode = internalMutation({\n  handler: async (ctx) => {\n    const health = await getProviderHealth(ctx);\n    const budget = await getBudgetStatus(ctx);\n    const latency = await getLatencyMetrics(ctx);\n    const breaker = await getCircuitBreakerState(ctx);\n    \n    let targetMode: 0 | 1 | 2 | 3;\n    let reason: string;\n    \n    if (\\!health.healthy || \\!breaker.closed) {\n      targetMode = 2;\n      reason = \\!health.healthy ? 'provider_unhealthy' : 'circuit_breaker_open';\n    } else if (\\!budget.ok || \\!latency.ok) {\n      targetMode = 1;\n      reason = \\!budget.ok ? 'budget_threshold' : 'latency_spike';\n    } else {\n      targetMode = 0;\n      reason = 'all_systems_nominal';\n    }\n    \n    await updateServiceMode(ctx, targetMode, reason);\n  },\n});\n```\n\n## Mode Transition Effects\nEach mode change triggers feature flag updates:\n```typescript\nconst MODE_FEATURES = {\n  0: { photos: true, openNow: true, providerSearch: true, autocomplete: true },\n  1: { photos: false, openNow: false, providerSearch: true, autocomplete: true },\n  2: { photos: false, openNow: false, providerSearch: false, autocomplete: false },\n  3: { photos: false, openNow: false, providerSearch: false, autocomplete: false },\n};\n\nasync function updateServiceMode(ctx, mode, reason) {\n  const current = await getCurrentMode(ctx);\n  if (current.mode === mode) return;\n  \n  // Update feature flags\n  const features = MODE_FEATURES[mode];\n  for (const [flag, enabled] of Object.entries(features)) {\n    await setFeatureFlag(ctx, flag, enabled, reason);\n  }\n  \n  // Log mode transition\n  await logModeTransition(ctx, current.mode, mode, reason);\n  \n  // Store new state\n  await ctx.db.patch(current._id, {\n    currentMode: mode,\n    reason,\n    enteredAt: Date.now(),\n  });\n}\n```\n\n## Query for Current Mode\n```typescript\nexport const getServiceMode = query({\n  handler: async (ctx) => {\n    const state = await ctx.db\n      .query('systemState')\n      .filter((q) => q.eq(q.field('key'), 'service_mode'))\n      .unique();\n    \n    return state ?? { currentMode: 0, reason: 'default' };\n  },\n});\n```\n\n## Scheduled Evaluation\nRun every minute via cron:\n```typescript\n// convex/crons.ts\ncrons.interval('evaluate_service_mode', { minutes: 1 }, internal.serviceMode.evaluateServiceMode);\n```\n\n## Acceptance Criteria\n- [ ] Mode transitions happening on triggers\n- [ ] Feature flags updating correctly\n- [ ] Mode history logged\n- [ ] Query returning current mode","notes":"Implementation complete by Claude (2026-01-27): Service Mode state machine fully implemented in convex/serviceMode.ts. All acceptance criteria met - mode transitions on triggers, feature flags updating, mode history logged, query returning current mode. Cron job runs every minute. Awaiting parent epic closure.","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:36:06.013327Z","created_by":"osekkat","updated_at":"2026-01-27T13:52:07.420400146Z","closed_at":"2026-01-27T13:52:07.420324602Z","compaction_level":0,"original_size":0,"labels":["core","resilience","service-modes"],"dependencies":[{"issue_id":"foodapp-l0vnyq","depends_on_id":"foodapp-2bm483","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-l0vnyq","depends_on_id":"foodapp-l201oy","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-l0vnyq","depends_on_id":"foodapp-nr7f89","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-l201oy","title":"Morocco Food Discovery App - Service Modes & Graceful Degradation","description":"## Overview\nThis epic implements the multi-level Service Mode system that replaces the binary 'Full vs Degraded' approach with progressive shedding.\n\n## Why Multi-Level Modes\nOriginal plan: basically on/off for degraded mode.\n\n**Problem**: Reliability and cost incidents benefit from progressive shedding, not all-or-nothing.\n\n**Solution**: Service Mode Levels 0-3\n\n## Service Mode Table\n\n| Mode | Trigger | Autocomplete/Search | Place Details | Photos | Map Pans |\n|------|---------|---------------------|--------------|--------|----------|\n| 0 (Normal) | healthy + budget ok | ✅ provider-first | ✅ provider-first | ✅ enabled | ✅ enabled |\n| 1 (Cost-Saver) | cost spike OR latency spike | ✅ provider-first (tighter limits) | ✅ (lite fields) | ❌ disabled | ✅ ID-only cache first |\n| 2 (Provider-Limited) | provider errors OR breaker open | ❌ (curated + owned search only) | ✅ only for saved/opened places | ❌ | ✅ ID-only cache only |\n| 3 (Offline/Owned Only) | offline OR emergency | ❌ | ❌ (owned cards + notes only) | ✅ UGC only | ✅ saved/curated only |\n\n## Benefits of Progressive Degradation\n1. **Smoother UX** - Features disappear gradually, not suddenly\n2. **Cheaper mitigation** - Turn off expensive surfaces first (photos → open-now → autocomplete)\n3. **Clearer operations** - 'We're in Mode 2 because budget exceeded'\n\n## UI Behavior by Mode\n- **Mode 1**: Subtle note only if user hits disabled feature ('Reduced features to keep things fast')\n- **Mode 2+**: Non-intrusive banner + explicit 'Browse guides/lists/saved places' affordances\n- Auto-dismiss when service recovers\n\n## Mode Manager Logic\nThe system mode manager decides current mode based on:\n1. Health check status (is provider responding?)\n2. Budget status (daily limits exceeded?)\n3. Error budget burn rate (SLO violation rate)\n4. Circuit breaker state\n\n## Auto-Mitigation Playbook\nWhen error budget burns >50%:\n1. Disable photos first (most expensive)\n2. Disable open-now filter\n3. Reduce max results / pagination\n4. Fall back to Mode 2 (curated + community only)\n\n## Health Check (Places API New)\n```typescript\nconst response = await fetch(\n  `https://places.googleapis.com/v1/places/${placeId}`,\n  {\n    headers: {\n      'Content-Type': 'application/json',\n      'X-Goog-Api-Key': process.env.GOOGLE_PLACES_KEY\\!,\n      'X-Goog-FieldMask': 'id',\n    },\n  }\n);\n```\n\n## Success Criteria\n- [ ] Mode transitions happening automatically on triggers\n- [ ] UI adapting to current mode\n- [ ] Cost savings measurable in Mode 1\n- [ ] App usable in Mode 2-3 with owned data","status":"closed","priority":0,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:22:03.701297Z","created_by":"osekkat","updated_at":"2026-01-27T17:04:58.308983825Z","closed_at":"2026-01-27T17:04:58.308952428Z","close_reason":"All child tasks completed: Service Mode state machine (foodapp-l0vnyq) and Service Mode UI feedback (foodapp-schg54) are both implemented and closed.","compaction_level":0,"original_size":0,"labels":["degradation","p0","resilience","service-modes"],"dependencies":[{"issue_id":"foodapp-l201oy","depends_on_id":"foodapp-dpikri","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-ltfikb","title":"Implement Popular Searches with privacy guardrails","description":"## Task\nImplement trending searches feature with privacy protections (k-anonymity, PII filtering).\n\n## Privacy Risks\nWithout guardrails, popular searches could expose:\n- Uniquely identifying queries ('my friend Ahmed's restaurant')\n- Phone numbers/emails pasted into search\n- Sensitive personal intent\n\n## Privacy Guardrails\n\n### K-Anonymity Threshold\nOnly display queries with ≥20 unique users:\n```typescript\nconst MIN_USERS_FOR_DISPLAY = 20;\n\nasync function getPopularSearches(city: string) {\n  const aggregates = await db.query('searchAggregates')\n    .filter(q => q.eq(q.field('city'), city))\n    .filter(q => q.gte(q.field('uniqueUsers'), MIN_USERS_FOR_DISPLAY))\n    .order('desc', 'count')\n    .take(10);\n  \n  return aggregates.map(a => a.normalizedQuery);\n}\n```\n\n### PII Filtering\nDrop queries containing:\n- Email patterns: `/[a-z]+@[a-z]+\\.[a-z]+/i`\n- Phone patterns: `/\\+?\\d{10,}/`\n- URL patterns: `/https?:\\/\\//`\n\n```typescript\nfunction containsPII(query: string): boolean {\n  const patterns = [\n    /[a-z0-9._%+-]+@[a-z0-9.-]+\\.[a-z]{2,}/i,\n    /\\+?\\d{10,}/,\n    /https?:\\/\\//,\n  ];\n  return patterns.some(p => p.test(query));\n}\n```\n\n### Retention Policy\n- Raw per-user query logs: 24-hour TTL max\n- Normalized aggregates: 30-day rolling window\n- Never store raw queries long-term\n\n## Aggregation Flow\n```\nUser searches 'best tagine'\n    ↓\nLog to recentSearches (short TTL)\n    ↓\nDaily cron job aggregates:\n  - Normalize queries\n  - Filter PII\n  - Count unique users\n  - Store in searchAggregates\n    ↓\nPopular searches query reads aggregates\n```\n\n## Schema Addition\n```typescript\nsearchAggregates: defineTable({\n  normalizedQuery: v.string(),\n  city: v.string(),\n  count: v.number(),\n  uniqueUsers: v.number(),\n  periodStart: v.number(),\n  periodEnd: v.number(),\n}).index('by_city_count', ['city', 'count']),\n```\n\n## Acceptance Criteria\n- [ ] K-anonymity threshold enforced\n- [ ] PII patterns filtered\n- [ ] Raw logs not retained beyond 24h\n- [ ] Popular searches displaying correctly","status":"closed","priority":2,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:28:36.474777Z","created_by":"osekkat","updated_at":"2026-01-27T17:30:17.935853550Z","closed_at":"2026-01-27T17:30:17.935754001Z","compaction_level":0,"original_size":0,"labels":["feature","privacy","search"],"dependencies":[{"issue_id":"foodapp-ltfikb","depends_on_id":"foodapp-il4keg","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-ltfikb","depends_on_id":"foodapp-inak6c","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-m02tur","title":"Implement priority classes for load shedding","description":"## Task\nImplement priority-based load shedding to protect critical user actions under load.\n\n## Priority Classes (highest to lowest)\n1. **P1: Place details** - Explicit user click, highest intent\n2. **P2: Search results** - Explicit search submit\n3. **P3: Autocomplete** - Typing, can degrade gracefully\n4. **P4: Photos + 'more results'** - Nice to have, shed first\n\n## Load Shedding Strategy\nWhen under pressure (approaching limits):\n1. Queue P4 requests, shed if queue grows\n2. Rate limit P3 more aggressively\n3. P1 and P2 always prioritized\n\n## Implementation\n```typescript\n// convex/providerGateway.ts\ninterface RequestOptions {\n  priority: 1 | 2 | 3 | 4;\n  canShed: boolean;\n  fallback?: () => Promise<any>;\n}\n\nasync function maybeShd(\n  ctx: ActionCtx,\n  options: RequestOptions\n): Promise<'proceed' | 'shed'> {\n  const load = await getCurrentLoad(ctx);\n  \n  if (load.level === 'critical' && options.priority >= 3) {\n    return 'shed';\n  }\n  if (load.level === 'high' && options.priority === 4) {\n    return 'shed';\n  }\n  return 'proceed';\n}\n```\n\n## Bulkhead Configuration\n- Max 25 concurrent provider calls per region\n- Separate queues per priority class\n- P4 queue has max depth (drop when full)\n\n## User Experience When Shed\n- Autocomplete: Show cached/recent suggestions only\n- Photos: Show placeholder + 'Loading...'\n- More results: 'Load more' button disabled temporarily\n\n## Metrics\n- requests_by_priority (counter)\n- requests_shed_by_priority (counter)\n- queue_depth_by_priority (gauge)\n\n## Acceptance Criteria\n- [ ] Priority classes respected under load\n- [ ] P4 sheds before P1/P2 affected\n- [ ] User-visible fallbacks working\n- [ ] Metrics tracking shed rate","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:26:51.534340Z","created_by":"osekkat","updated_at":"2026-01-27T17:10:57.587348463Z","closed_at":"2026-01-27T17:10:57.587257408Z","compaction_level":0,"original_size":0,"labels":["load-shedding","performance","resilience"],"dependencies":[{"issue_id":"foodapp-m02tur","depends_on_id":"foodapp-2bm483","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-m02tur","depends_on_id":"foodapp-dpikri","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-mr5b9g","title":"Implement photo proxy route handler with signed URLs","description":"## Task\nBuild the Next.js photo proxy route handler with signed URL support for hotlink prevention.\n\n## Route Structure\n```\n/api/photos/[placeId]/[photoRef]/route.ts\n```\n\n## Request Format\n```\n/api/photos/{placeId}/{photoRef}?size=medium&exp=1706000000&sig=abc123\n```\n\n## Signed URL Generation\n```typescript\n// lib/photoUrls.ts\nconst SIGNING_SECRET = process.env.PHOTO_SIGNING_SECRET;\n\nexport function generateSignedPhotoUrl(\n  placeId: string,\n  photoRef: string,\n  size: 'thumbnail' | 'medium' | 'full',\n  ttlSeconds: number = 900\n): string {\n  const exp = Math.floor(Date.now() / 1000) + ttlSeconds;\n  const payload = `${placeId}:${photoRef}:${size}:${exp}`;\n  const sig = createHmac('sha256', SIGNING_SECRET)\n    .update(payload)\n    .digest('base64url');\n  \n  return `/api/photos/${placeId}/${photoRef}?size=${size}&exp=${exp}&sig=${sig}`;\n}\n\nexport function verifySignature(\n  placeId: string,\n  photoRef: string,\n  size: string,\n  exp: string,\n  sig: string\n): boolean {\n  const expNum = parseInt(exp);\n  if (expNum < Date.now() / 1000) return false; // Expired\n  \n  const payload = `${placeId}:${photoRef}:${size}:${exp}`;\n  const expected = createHmac('sha256', SIGNING_SECRET)\n    .update(payload)\n    .digest('base64url');\n  \n  return timingSafeEqual(Buffer.from(sig), Buffer.from(expected));\n}\n```\n\n## Route Handler\n```typescript\n// app/api/photos/[placeId]/[photoRef]/route.ts\nimport { NextRequest, NextResponse } from 'next/server';\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: { placeId: string; photoRef: string } }\n) {\n  const { placeId, photoRef } = params;\n  const { searchParams } = new URL(request.url);\n  const size = searchParams.get('size') || 'medium';\n  const exp = searchParams.get('exp');\n  const sig = searchParams.get('sig');\n  \n  // Verify signature (in production)\n  if (process.env.NODE_ENV === 'production') {\n    if (!exp || !sig || !verifySignature(placeId, photoRef, size, exp, sig)) {\n      return new NextResponse('Invalid signature', { status: 403 });\n    }\n  }\n  \n  // Check feature flag via Convex\n  const photosEnabled = await checkFeatureFlag('photos');\n  if (!photosEnabled) {\n    return new NextResponse('Photos disabled', { status: 503 });\n  }\n  \n  // Fetch from Google via ProviderGateway\n  const photoUrl = await fetchPhotoFromProvider(photoRef, size);\n  const response = await fetch(photoUrl);\n  \n  // Return with explicit cache headers\n  return new NextResponse(response.body, {\n    headers: {\n      'Content-Type': response.headers.get('content-type') || 'image/jpeg',\n      'Cache-Control': 'public, s-maxage=900, max-age=300, stale-while-revalidate=60',\n    },\n  });\n}\n```\n\n## Size Mapping\n```typescript\nconst SIZE_MAP = {\n  thumbnail: 100,  // maxHeightPx\n  medium: 400,\n  full: 1000,\n};\n```\n\n## Integration with ProviderGateway\nThe photo proxy MUST go through ProviderGateway:\n- Budget enforcement\n- Circuit breaker\n- Metrics\n\n## Acceptance Criteria\n- [ ] Route handler working\n- [ ] Signed URLs generated and verified\n- [ ] Unauthorized requests rejected\n- [ ] Cache headers correct\n- [ ] Going through ProviderGateway","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:37:28.582666Z","created_by":"osekkat","updated_at":"2026-01-27T15:46:03.081192125Z","closed_at":"2026-01-27T15:46:03.081137083Z","close_reason":"Photo proxy route handler fully implemented with signed URLs, ProviderGateway integration, circuit breaker, budget tracking, and metrics","compaction_level":0,"original_size":0,"labels":["api","photos","security"],"dependencies":[{"issue_id":"foodapp-mr5b9g","depends_on_id":"foodapp-8q1iji","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-mr5b9g","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-mr5b9g","depends_on_id":"foodapp-cmnis6","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-nr7f89","title":"Implement circuit breaker state machine","description":"## Task\nImplement circuit breaker pattern to prevent cascade failures when the provider is having issues.\n\n## States\n1. **Closed** (normal) - Requests flow through\n2. **Open** - After threshold failures, reject immediately, serve stale cache\n3. **Half-Open** - After cooldown, allow one test request\n\n## Thresholds\n- Open after: 5 consecutive failures OR 50% error rate in 1 minute\n- Half-open after: 30 seconds in Open state\n- Close after: 1 successful request in Half-Open\n\n## Implementation\n```typescript\n// convex/circuitBreaker.ts\ninterface CircuitBreakerState {\n  state: 'closed' | 'open' | 'half_open';\n  failureCount: number;\n  lastFailureAt: number;\n  lastSuccessAt: number;\n  openedAt?: number;\n}\n\nexport async function withCircuitBreaker<T>(\n  ctx: ActionCtx,\n  serviceKey: string,\n  operation: () => Promise<T>,\n  fallback?: () => Promise<T>\n): Promise<T> {\n  const state = await getState(ctx, serviceKey);\n  \n  if (state.state === 'open') {\n    if (shouldTryHalfOpen(state)) {\n      // Allow test request\n    } else {\n      // Reject immediately, use fallback\n      return fallback?.() ?? throwCircuitOpen();\n    }\n  }\n  \n  try {\n    const result = await operation();\n    await recordSuccess(ctx, serviceKey);\n    return result;\n  } catch (error) {\n    await recordFailure(ctx, serviceKey, error);\n    throw error;\n  }\n}\n```\n\n## Integration with Service Modes\n- Circuit breaker open → triggers Mode 2 (Provider-Limited)\n- Mode manager subscribes to breaker state changes\n\n## Metrics\n- breaker_state_changes (counter)\n- breaker_rejections (counter)\n- breaker_half_open_success_rate (gauge)\n\n## Acceptance Criteria\n- [ ] State machine transitions correctly\n- [ ] Fallback triggered when open\n- [ ] Half-open test requests working\n- [ ] Metrics tracking state changes","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:26:02.198554Z","created_by":"osekkat","updated_at":"2026-01-27T10:18:37.714155604Z","closed_at":"2026-01-27T10:18:37.714109885Z","close_reason":"Implemented full circuit breaker state machine with Closed/Open/Half-Open states. Functions: getCircuitBreakerState, recordCircuitFailure, recordCircuitSuccess, recordHalfOpenAttempt. Tracks consecutive failures with threshold-based opening, cooldown-based half-open transition, and success-based closing.","compaction_level":0,"original_size":0,"labels":["circuit-breaker","core","resilience"],"dependencies":[{"issue_id":"foodapp-nr7f89","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-nr7f89","depends_on_id":"foodapp-dpikri","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-nxpa51","title":"Implement place details page with provider + owned data","description":"## Task\nBuild the place details page that combines ephemeral provider data with persistent owned data.\n\n## URL Structure\n- Provider places: `/place/g/[googlePlaceId]`\n- Curated places: `/place/c/[slug]`\n\n## Data Flow\n```\nUser clicks place\n    ↓\nDerive placeKey from URL (g:xxx or c:xxx)\n    ↓\nParallel fetch:\n  1. Provider details (if g: prefix) via ProviderGateway\n  2. Owned data via Convex query (reviews, favorites, tags, notes)\n    ↓\nRender combined view\n```\n\n## Provider Data (Ephemeral)\nFetched fresh, never persisted:\n- displayName, formattedAddress\n- regularOpeningHours\n- rating, userRatingCount\n- photos (references only)\n- websiteUri, phoneNumber\n\n## Owned Data (Persistent)\nFrom Convex by placeKey:\n- Community rating (communityRatingAvg/Count)\n- Favorites count\n- Taste tags with votes\n- User reviews\n- Personal note/nickname (if user has one)\n- Curated card data (if exists)\n\n## Page Sections\n1. **Header**: Name, address, rating badges\n2. **Photo gallery**: Provider photos + UGC photos\n3. **What to order**: Top dishes (owned)\n4. **Curated card**: Editorial tips (if exists)\n5. **Actions**: Call, Directions, Share, Save\n6. **Taste tags**: Community voting\n7. **Reviews**: With helpful votes\n\n## No-Store Directive\n```typescript\n// app/place/g/[googlePlaceId]/page.tsx\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\nexport async function generateMetadata() {\n  return {\n    robots: 'noindex', // Don't index provider-backed pages\n  };\n}\n```\n\n## Acceptance Criteria\n- [ ] Provider details fetching correctly\n- [ ] Owned data overlaying correctly\n- [ ] No-store headers set\n- [ ] Actions (call/directions/share) working","notes":"Implementation complete by TealOtter: Added convex/placeDetails.ts with queries for community data, reviews, user status, and curated overlay. Created components/places/ with PlaceDetails, PlaceHeader, PlaceActions, PlaceHours, TasteTags, ReviewCard. Updated app/(main)/place/g/[googlePlaceId]/page.tsx and app/(main)/place/c/[slug]/page.tsx to use the new PlaceDetails component. Provider data fetched via ProviderGateway action, owned data from Convex queries.","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:31:34.740594Z","created_by":"osekkat","updated_at":"2026-01-27T12:06:26.216610534Z","closed_at":"2026-01-27T12:06:26.216548381Z","compaction_level":0,"original_size":0,"labels":["core","places","ui"],"dependencies":[{"issue_id":"foodapp-nxpa51","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-nxpa51","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-nxpa51","depends_on_id":"foodapp-tpsmbw","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-oec6mt","title":"Initialize Convex backend","description":"## Task\nSet up Convex as the backend platform for real-time database and serverless functions.\n\n## Commands\n```bash\nnpm install convex\nnpx convex dev  # Creates project and syncs schema\n```\n\n## Why Convex\n- **Real-time by default**: Reviews, lists, favorites update instantly\n- **Type-safe**: Full TypeScript from database to frontend\n- **Serverless functions**: No separate API routes needed\n- **Built-in auth**: Convex Auth handles OAuth and sessions\n\n## Initial Setup\n1. Create Convex account/project\n2. Install convex package\n3. Run `npx convex dev` to create .convex directory\n4. Configure environment variables in Convex dashboard\n\n## Project Structure\n```\nconvex/\n├── _generated/     # Auto-generated types\n├── schema.ts       # Database schema\n├── auth.ts         # Auth configuration\n└── ...             # Functions\n```\n\n## Acceptance Criteria\n- [ ] Convex dashboard accessible\n- [ ] `npx convex dev` running without errors\n- [ ] Basic schema deploying successfully\n- [ ] Frontend can connect to Convex","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:23:41.597891Z","created_by":"osekkat","updated_at":"2026-01-27T10:11:36.504761382Z","closed_at":"2026-01-27T10:11:36.504731147Z","close_reason":"Convex already initialized: convex/_generated present and .env.local has CONVEX_DEPLOYMENT + NEXT_PUBLIC_CONVEX_URL.","compaction_level":0,"original_size":0,"labels":["convex","setup"],"dependencies":[{"issue_id":"foodapp-oec6mt","depends_on_id":"foodapp-hktdvu","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-oec6mt","depends_on_id":"foodapp-qpbwny","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-okcm4c","title":"Implement 'Search this area' with debouncing","description":"## Task\nImplement the 'Search this area' button that triggers bounded search when map pans.\n\n## UX Flow\n1. User pans/zooms map\n2. After settling (debounce), show 'Search this area' button\n3. User clicks → trigger bounded search\n4. Results update on map + list\n\n## Why Button Instead of Auto-Search\n- Explicit user intent = lower cost\n- Prevents accidental searches during casual panning\n- User controls when to 'spend' a search\n\n## Debouncing\n```typescript\n// 300ms debounce on bounds change\nconst debouncedBoundsChange = useMemo(\n  () => debounce((bounds: LatLngBounds) => {\n    setShowSearchButton(true);\n    setPendingBounds(bounds);\n  }, 300),\n  []\n);\n```\n\n## Bounded Search Call\nUses Text Search (New) with rectangle locationRestriction:\n```typescript\nasync function searchArea(bounds: LatLngBounds, query?: string) {\n  return providerGateway.textSearch({\n    textQuery: query || 'restaurant',\n    locationRestriction: {\n      rectangle: {\n        low: { latitude: bounds.south, longitude: bounds.west },\n        high: { latitude: bounds.north, longitude: bounds.east },\n      },\n    },\n    fieldMask: FIELD_SETS.SEARCH_LITE,\n  });\n}\n```\n\n## Rate Limiting\nSeparate rate limit for map searches:\n- More restrictive than text search\n- Prevents rapid re-searching\n- Shows 'Please wait...' if limit hit\n\n## Stampede Protection\nUnder load:\n- Serve cached tile IDs\n- Show 'Results may be incomplete' hint\n- Button disabled temporarily\n\n## Acceptance Criteria\n- [ ] Button appears after pan settles\n- [ ] Bounded search working correctly\n- [ ] Results updating on map + list\n- [ ] Rate limiting respected","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:31:06.519320Z","created_by":"osekkat","updated_at":"2026-01-27T15:53:26.608844906Z","closed_at":"2026-01-27T15:53:26.608813078Z","close_reason":"Completed: Implemented Search this area with debouncing. Components created: useMapSearch hook (hooks/useMapSearch.ts) with 300ms debounce, rate limiting, and cooldown; SearchThisAreaButton (components/search/SearchThisAreaButton.tsx) with loading/cooldown states; MapWithSearch (components/maps/MapWithSearch.tsx) integrated component. All acceptance criteria met: button appears after pan settles, debouncing working, rate limiting respected.","compaction_level":0,"original_size":0,"labels":["map","search","ui"],"dependencies":[{"issue_id":"foodapp-okcm4c","depends_on_id":"foodapp-6e5efz","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-okcm4c","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-okcm4c","depends_on_id":"foodapp-ep42ns","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-popupy","title":"Implement curated place cards system","description":"## Task\nBuild the editorial curated place cards - owned content that powers SEO, offline, and degraded mode.\n\n## What Curated Cards Contain\nAll OWNED content (no provider data):\n- title: Display name we own\n- slug: URL-friendly identifier\n- summary: Editorial description\n- mustTry: Array of recommended dishes\n- priceNote: e.g., '30-70 MAD'\n- tags: Amenities/vibes (cash-only, wifi, family)\n- coverStorageId: Our own photo\n- neighborhood, city\n- linkedPlaceKey: Optional link to provider place\n\n## Schema\n```typescript\ncuratedPlaces: defineTable({\n  title: v.string(),\n  slug: v.string(),\n  city: v.string(),\n  neighborhood: v.optional(v.string()),\n  placeKey: v.string(),                 // 'c:' + slug\n  linkedPlaceKey: v.optional(v.string()), // 'g:...' if linked\n  summary: v.string(),\n  mustTry: v.optional(v.array(v.string())),\n  priceNote: v.optional(v.string()),\n  tags: v.optional(v.array(v.string())),\n  coverStorageId: v.optional(v.id('_storage')),\n  locale: v.string(),\n  publishedAt: v.optional(v.number()),\n  featured: v.boolean(),\n  sortOrder: v.number(),\n})\n  .index('by_slug', ['slug'])\n  .index('by_city_featured', ['city', 'featured', 'sortOrder']),\n```\n\n## Two Types of Curated Places\n\n### Standalone (placeKey = 'c:xxx')\n- No provider backing\n- All content is owned\n- Works completely offline\n\n### Linked (placeKey = 'c:xxx', linkedPlaceKey = 'g:yyy')\n- Editorial overlay on provider place\n- Can show provider details when available\n- Falls back to curated card when provider unavailable\n\n## Admin CRUD\n```typescript\nexport const createCuratedPlace = mutation({\n  args: { /* ... */ },\n  handler: async (ctx, args) => {\n    await requireRole(ctx, ['admin', 'editor']);\n    \n    const placeKey = `c:${args.slug}`;\n    \n    // Create curated place\n    await ctx.db.insert('curatedPlaces', {\n      ...args,\n      placeKey,\n      createdAt: Date.now(),\n    });\n    \n    // Also create places anchor for UGC\n    await ctx.db.insert('places', {\n      placeKey,\n      communityRatingCount: 0,\n      favoritesCount: 0,\n      createdAt: Date.now(),\n      lastSeenAt: Date.now(),\n    });\n    \n    // Audit log\n    await logAction(ctx, 'curatedPlace.create', placeKey);\n  },\n});\n```\n\n## Featured on Home\nQuery for featured curated places by city:\n```typescript\nexport const getFeaturedPlaces = query({\n  args: { city: v.string() },\n  handler: async (ctx, { city }) => {\n    return ctx.db\n      .query('curatedPlaces')\n      .withIndex('by_city_featured', (q) =>\n        q.eq('city', city).eq('featured', true)\n      )\n      .order('asc')\n      .take(10);\n  },\n});\n```\n\n## Acceptance Criteria\n- [ ] Curated place CRUD working\n- [ ] Both standalone and linked types supported\n- [ ] Featured places query working\n- [ ] Admin-only access enforced","notes":"Implementation complete by Claude (2026-01-27): convex/curatedPlaces.ts (576 lines) fully implemented with standalone/linked place types, RBAC-protected admin CRUD, public queries (by slug, city, featured), and stats. All owned content, no provider data stored. Awaiting parent epic closure.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:33:16.749115Z","created_by":"osekkat","updated_at":"2026-01-27T13:54:01.475884373Z","closed_at":"2026-01-27T13:54:01.475800218Z","compaction_level":0,"original_size":0,"labels":["core","curated","editorial"],"dependencies":[{"issue_id":"foodapp-popupy","depends_on_id":"foodapp-2ym9m1","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-popupy","depends_on_id":"foodapp-83tb1i","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-popupy","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-qi7o1i","title":"Implement singleflight request coalescing","description":"## Task\nImplement singleflight pattern to coalesce identical in-flight provider requests within the same server instance.\n\n## Problem\nWithout singleflight:\n- 20 users open same place → 20 provider calls\n- Popular restaurant gets mobbed → stampede\n- Map pan with concurrent users → amplified load\n\n## Solution\nCoalesce identical requests keyed by request signature:\n\n### Request Signatures\n- Details: `{placeId, fieldSet, language, region}`\n- Search: `{query, bounds, filters, fieldSet, language, region}`\n- Photos: `{photoRef, size}`\n\n## Implementation\n```typescript\n// lib/singleflight.ts\nconst inFlight = new Map<string, Promise<any>>();\n\nexport async function singleflight<T>(\n  key: string,\n  operation: () => Promise<T>\n): Promise<T> {\n  const existing = inFlight.get(key);\n  if (existing) {\n    return existing as Promise<T>;\n  }\n  \n  const promise = operation().finally(() => {\n    inFlight.delete(key);\n  });\n  \n  inFlight.set(key, promise);\n  return promise;\n}\n```\n\n## Key Generation\n```typescript\nfunction detailsKey(params: DetailsParams): string {\n  return `details:${params.placeId}:${params.fieldSet}:${params.language}:${params.region}`;\n}\n```\n\n## Considerations\n- Works per server instance (not distributed)\n- For Convex Actions, consider using a short-TTL cache for distributed coalescing\n- Don't coalesce if responses are user-specific\n\n## Metrics\n- singleflight_hits (counter) - Request coalesced\n- singleflight_misses (counter) - New request started\n\n## Acceptance Criteria\n- [ ] Identical concurrent requests share one upstream call\n- [ ] Different requests not incorrectly coalesced\n- [ ] Metrics showing coalescing effectiveness","notes":"Implementation complete by Claude (2026-01-27): lib/singleflight.ts fully implemented with core singleflight function, key generators (detailsKey, searchKey, photoKey, autocompleteKey), metrics (hits/misses/active), and comprehensive test suite (25 tests). Coordinates rounded to 3 decimal places for key reuse. Ready for ProviderGateway integration.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:26:25.553442Z","created_by":"osekkat","updated_at":"2026-01-27T13:57:27.389098829Z","closed_at":"2026-01-27T13:57:27.388970958Z","compaction_level":0,"original_size":0,"labels":["core","performance","singleflight"],"dependencies":[{"issue_id":"foodapp-qi7o1i","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-qi7o1i","depends_on_id":"foodapp-dpikri","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-qpbwny","title":"Morocco Food Discovery App - Project Foundation & Infrastructure","description":"## Overview\nThis epic establishes the foundational infrastructure for the Morocco Food Discovery App. It covers repository setup, environment configuration, core dependencies, and the base architectural patterns that all other features will build upon.\n\n## Strategic Importance\nGetting the foundation right is critical because:\n1. **Policy-first architecture** must be baked in from day one - retrofitting compliance is expensive and error-prone\n2. **Cost controls** need to be structural, not bolted on - Google Places API costs can spiral quickly\n3. **Developer experience** shapes velocity - proper tooling and patterns prevent friction later\n\n## Key Decisions Made\n- **Convex** for backend: Real-time by default, TypeScript end-to-end, serverless\n- **Next.js 16.x** with App Router: Modern React patterns, explicit no-store for provider routes\n- **Separate API keys**: Browser key (Maps JS) vs Server key (Places API) with different restrictions\n\n## Success Criteria\n- [ ] All environments (dev/staging/prod) properly isolated\n- [ ] CI/CD pipeline running with compliance tests as gates\n- [ ] Observability stack capturing metrics from first deploy\n- [ ] Rate limiting and circuit breaker patterns in place before any provider calls\n\n## Risks to Monitor\n- Accidental key exposure in client bundles\n- Missing env vars causing silent failures\n- Convex schema migrations in production","status":"closed","priority":0,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:21:10.862870Z","created_by":"osekkat","updated_at":"2026-01-27T15:45:44.753644863Z","closed_at":"2026-01-27T15:45:44.753602229Z","close_reason":"All foundation tasks completed: Next.js init, Convex init, schema, Google Cloud, Auth, Sentry, shadcn/ui","compaction_level":0,"original_size":0,"labels":["foundation","infrastructure","p0"]}
{"id":"foodapp-schg54","title":"Implement Service Mode UI feedback","description":"## Task\nBuild the UI components that communicate service mode status to users appropriately.\n\n## UI Behavior by Mode\n\n### Mode 0 (Normal)\n- No indicators\n- Full functionality\n\n### Mode 1 (Cost-Saver)\n- Subtle note ONLY when user hits disabled feature:\n  - 'Reduced features to keep things fast'\n  - Show when: photo fails to load, open-now filter used\n- Don't show banner proactively\n\n### Mode 2+ (Provider-Limited / Offline)\n- Non-intrusive banner at top\n- Explicit affordances: 'Browse guides', 'View saved places', 'Explore lists'\n- Hide/disable provider-dependent UI elements\n- Auto-dismiss when service recovers\n\n## Implementation\n\n### ServiceModeProvider\n```typescript\n// components/providers/ServiceModeProvider.tsx\nexport function ServiceModeProvider({ children }) {\n  const mode = useQuery(api.serviceMode.getServiceMode);\n  \n  return (\n    <ServiceModeContext.Provider value={mode}>\n      {mode?.currentMode >= 2 && <DegradedModeBanner mode={mode} />}\n      {children}\n    </ServiceModeContext.Provider>\n  );\n}\n```\n\n### DegradedModeBanner\n```typescript\n// components/feedback/DegradedModeBanner.tsx\nexport function DegradedModeBanner({ mode }) {\n  const [dismissed, setDismissed] = useState(false);\n  \n  if (dismissed) return null;\n  \n  return (\n    <div className='bg-amber-50 border-b border-amber-200 px-4 py-2'>\n      <div className='flex items-center justify-between'>\n        <p className='text-sm text-amber-800'>\n          Some features are limited right now. \n          <Link href='/guides' className='underline ml-1'>\n            Browse guides\n          </Link>\n          {' or '}\n          <Link href='/lists' className='underline'>\n            view saved places\n          </Link>\n        </p>\n        <button onClick={() => setDismissed(true)}>\n          <X className='h-4 w-4' />\n        </button>\n      </div>\n    </div>\n  );\n}\n```\n\n### useFeatureFlag Hook\n```typescript\nexport function useFeatureFlag(flag: string): boolean {\n  const flags = useQuery(api.featureFlags.getAll);\n  return flags?.[flag] ?? true; // Default to enabled if not loaded\n}\n\n// Usage in component\nfunction PhotoGallery({ photos }) {\n  const photosEnabled = useFeatureFlag('photos');\n  \n  if (!photosEnabled) {\n    return <PhotosDisabledPlaceholder />;\n  }\n  \n  return <ActualPhotoGallery photos={photos} />;\n}\n```\n\n### Mode 1 Subtle Feedback\n```typescript\nfunction PhotosDisabledPlaceholder() {\n  return (\n    <div className='bg-gray-100 rounded-lg p-4 text-center'>\n      <ImageIcon className='h-8 w-8 mx-auto text-gray-400 mb-2' />\n      <p className='text-sm text-gray-600'>\n        Reduced features to keep things fast\n      </p>\n    </div>\n  );\n}\n```\n\n## Auto-Recovery\nWhen mode returns to 0:\n- Banner auto-dismisses\n- Features re-enable without reload (Convex reactivity)\n- Optional: brief 'Back online!' toast\n\n## Acceptance Criteria\n- [ ] Mode 1 shows subtle feedback only on interaction\n- [ ] Mode 2+ shows banner with alternatives\n- [ ] Banner dismissible\n- [ ] Auto-recovery working\n- [ ] Feature flags controlling UI elements","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:36:25.160132Z","created_by":"osekkat","updated_at":"2026-01-27T16:23:26.407983595Z","closed_at":"2026-01-27T16:23:26.407923755Z","close_reason":"Completed","compaction_level":0,"original_size":0,"labels":["feedback","resilience","ui"],"dependencies":[{"issue_id":"foodapp-schg54","depends_on_id":"foodapp-l0vnyq","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-schg54","depends_on_id":"foodapp-l201oy","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-t54nup","title":"Implement review CRUD with one-per-user-per-place","description":"## Task\nImplement review creation, editing, and deletion with enforcement of one review per user per place.\n\n## One Review Per Place Policy\nUsers don't create new reviews for a place they've already reviewed - they EDIT.\n\n```typescript\n// convex/reviews.ts\nexport const upsertReview = mutation({\n  args: {\n    placeKey: v.string(),\n    rating: v.number(),\n    text: v.optional(v.string()),\n    dishesTried: v.optional(v.array(v.string())),\n    // ...\n  },\n  handler: async (ctx, args) => {\n    const userId = await requireAuth(ctx);\n    \n    const existing = await ctx.db\n      .query('reviews')\n      .withIndex('by_user_place', (q) =>\n        q.eq('userId', userId).eq('placeKey', args.placeKey)\n      )\n      .unique();\n    \n    if (existing) {\n      // Update existing review\n      await recordEditHistory(ctx, existing._id, args);\n      return ctx.db.patch(existing._id, {\n        ...args,\n        updatedAt: Date.now(),\n      });\n    } else {\n      // Create new review\n      return ctx.db.insert('reviews', {\n        userId,\n        ...args,\n        helpfulCount: 0,\n        createdAt: Date.now(),\n      });\n    }\n  },\n});\n```\n\n## Review Structure\n```typescript\n{\n  userId: Id<'users'>,\n  placeKey: string,\n  rating: number,          // 1-5\n  text: string,            // 10-2000 chars\n  dishesTried: string[],   // What they ordered\n  pricePaidBucketMad: string, // '<30' | '30-70' | '70-150' | '150+'\n  visitContext: string,    // 'solo' | 'couple' | 'family' | 'friends'\n  photoIds: Id<'ugcPhotos'>[],\n  helpfulCount: number,\n  createdAt: number,\n  updatedAt?: number,\n  deletedAt?: number,      // Soft delete\n}\n```\n\n## Edit History\nEvery edit records previous state:\n```typescript\nreviewEdits: {\n  reviewId: Id<'reviews'>,\n  editorUserId: Id<'users'>,\n  prevText: string,\n  nextText: string,\n  editedAt: number,\n}\n```\n\n## Soft Delete\nReviews are soft-deleted (retain for moderation/audit):\n```typescript\nexport const deleteReview = mutation({\n  args: { reviewId: v.id('reviews') },\n  handler: async (ctx, { reviewId }) => {\n    await ctx.db.patch(reviewId, { deletedAt: Date.now() });\n    // Don't actually delete - keeps audit trail\n  },\n});\n```\n\n## Aggregate Updates\nOn review create/update/delete, update place aggregates:\n- communityRatingAvg\n- communityRatingCount\n\n## Acceptance Criteria\n- [ ] One review per user per place enforced\n- [ ] Edit updates existing review\n- [ ] Edit history recorded\n- [ ] Soft delete working\n- [ ] Aggregates updating correctly","notes":"Implementation complete by Claude (2026-01-27): convex/reviews.ts fully implemented with upsertReview (one-per-user-per-place policy), deleteReview (soft delete), helpful votes system, edit history for moderation, and aggregate updates. RBAC checks for edit history viewing. Awaiting parent epic closure.","status":"closed","priority":1,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:31:50.508733Z","created_by":"osekkat","updated_at":"2026-01-27T13:53:48.180246096Z","closed_at":"2026-01-27T13:53:48.180156972Z","compaction_level":0,"original_size":0,"labels":["core","reviews","ugc"],"dependencies":[{"issue_id":"foodapp-t54nup","depends_on_id":"foodapp-83tb1i","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-t54nup","depends_on_id":"foodapp-kri2kv","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-t54nup","depends_on_id":"foodapp-tpsmbw","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-tpsmbw","title":"Morocco Food Discovery App - Place Details & UGC Layer","description":"## Overview\nThis epic builds the place details experience and the User-Generated Content (UGC) layer that creates differentiation and value independent of the provider.\n\n## Place Identity Model\nEvery place uses a namespaced `placeKey`:\n- Google places: `placeKey = 'g:' + place_id`\n- Curated-only: `placeKey = 'c:' + slug`\n- Future providers: `placeKey = '<provider>:' + id`\n\nAll UGC references placeKey, not Convex doc IDs. This enables:\n- Provider-agnostic community content\n- Smooth migration if provider changes\n- Curated places that don't need provider backing\n\n## Place Details Flow\n1. User clicks place → fetch provider details with FieldMask\n2. Join with owned data by placeKey (reviews, favorites, tags, notes)\n3. Render combined view: provider content (ephemeral) + owned overlays (persistent)\n4. Provider content NEVER persisted, NEVER cached beyond response\n\n## What to Order (New Feature)\nTop dishes derived from:\n- UGC `dishesTried` aggregated in placeDishes table\n- Editorial `mustTry` from curated cards\n\nThis is a differentiator: Google doesn't know what specific dishes are good at a restaurant.\n\n## UGC Photo Moderation (Improved)\nOriginal plan had `photoStorageIds` on reviews - no moderation metadata.\n\nNew ugcPhotos table provides:\n- Per-photo moderation status (pending/approved/rejected)\n- EXIF stripping (privacy)\n- Blurhash + perceptual hash (spam/dup detection)\n- NSFW scores from Cloud Vision\n- Independent lifecycle from reviews\n\n## Reviews with Structure\n- One review per user per place (edit, don't duplicate)\n- Structured fields: rating, dishesTried, pricePaidBucketMad, visitContext\n- Helpful votes with count denormalization\n- Edit history for moderation audit\n\n## Personal Notes & Nicknames\nUsers can add private notes + nicknames to saved places:\n- Helps offline recognition\n- Enhances list clarity\n- Entirely owned data\n\n## Success Criteria\n- [ ] Place details load P95 <800ms\n- [ ] UGC photos have full moderation pipeline\n- [ ] 'What to order' showing meaningful suggestions\n- [ ] Reviews enforcing one-per-user-per-place","status":"closed","priority":1,"issue_type":"epic","owner":"osekkat@gmail.com","created_at":"2026-01-26T16:22:21.246548Z","created_by":"osekkat","updated_at":"2026-01-27T17:56:14.992331297Z","closed_at":"2026-01-27T17:56:14.992289474Z","close_reason":"All child tasks completed: place details page, optimistic updates, taste tags, UGC photos, review CRUD","compaction_level":0,"original_size":0,"labels":["p1","photos","places","reviews","ugc"],"dependencies":[{"issue_id":"foodapp-tpsmbw","depends_on_id":"foodapp-dpikri","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
{"id":"foodapp-tuvm91","title":"Implement compliance tests for policy enforcement","description":"## Task\nCreate compliance regression tests that act as CI gates - failures block deployment.\n\n## Why This is Critical\nAccidental policy violations can happen through:\n- Developer adding logging statement\n- Analytics event including wrong fields\n- Next.js route missing no-store directive\n- Client storage accidentally caching provider data\n\nThese tests catch violations before they reach production.\n\n## Test Categories\n\n### 1. No Provider Content in Persistence\n```typescript\ntest('provider response never written to Convex', async () => {\n  // Mock a provider response with restricted content\n  const providerResponse = {\n    displayName: 'Cafe Clock',\n    formattedAddress: '123 Medina...',\n    // ... more restricted fields\n  };\n  \n  // Trigger the flow that processes this\n  await processPlaceSearch(providerResponse);\n  \n  // Assert that restricted fields are not in DB\n  const dbRecords = await getAllPlaceRecords();\n  for (const record of dbRecords) {\n    expect(record).not.toHaveProperty('displayName');\n    expect(record).not.toHaveProperty('formattedAddress');\n    // Only placeKey, lat, lng (with expiry) allowed\n  }\n});\n```\n\n### 2. No Provider Content in Analytics\n```typescript\ntest('analytics events use placeKey only', async () => {\n  const events = captureAnalyticsEvents(() => {\n    trackPlaceView(placeData);\n  });\n  \n  for (const event of events) {\n    expect(event.properties.placeKey).toBeDefined();\n    expect(event.properties.name).toBeUndefined();\n    expect(event.properties.address).toBeUndefined();\n  }\n});\n```\n\n### 3. Provider Routes are no-store\n```typescript\ntest('place detail route has no-store', async () => {\n  const response = await fetch('/place/g/ChIJ...');\n  expect(response.headers.get('cache-control'))\n    .toContain('no-store');\n});\n```\n\n### 4. No Provider Content in Sentry\n```typescript\ntest('Sentry events redact provider content', () => {\n  const event = createTestSentryEvent({\n    extra: { providerResponse: { displayName: 'Test' } }\n  });\n  \n  const filtered = beforeSend(event);\n  expect(filtered.extra.providerResponse).toBeUndefined();\n});\n```\n\n## CI Integration\nThese tests run on every PR. Any failure = blocked merge.\n\n## Acceptance Criteria\n- [ ] All four test categories implemented\n- [ ] Tests running in CI\n- [ ] Failures blocking deployment\n- [ ] Clear error messages explaining violation","notes":"Implementation complete by Claude (2026-01-27): All 4 compliance test categories implemented in tests/compliance/. Tests: policy-enforcement.test.ts (15 tests), analytics-redaction.test.ts (14 tests), sentry-redaction.test.ts (13 tests), route-headers.test.ts (13 tests). All 118 tests passing. Awaiting parent epic closure.","status":"closed","priority":0,"issue_type":"task","owner":"osekkat@gmail.com","created_at":"2026-01-26T17:27:07.463132Z","created_by":"osekkat","updated_at":"2026-01-27T13:51:57.317527445Z","closed_at":"2026-01-27T13:51:57.317435308Z","compaction_level":0,"original_size":0,"labels":["compliance","policy","testing"],"dependencies":[{"issue_id":"foodapp-tuvm91","depends_on_id":"foodapp-99njj0","type":"blocks","created_at":"2026-01-27T09:26:10Z","created_by":"import"},{"issue_id":"foodapp-tuvm91","depends_on_id":"foodapp-dpikri","type":"parent-child","created_at":"2026-01-27T09:26:10Z","created_by":"import"}]}
